# ä»Šæ—¥å­¦ä¹ æ€»ç»“ï¼šäº‹åŠ¡ç®¡ç†ã€æ–‡ä»¶ä¸Šä¼ ä¸æ›´å¤š

## å‰è¨€
ä¸‹åˆ4ç‚¹äº†ï¼Œæ²¡å¿ä½ç©äº†ä¼šæ¸¸æˆğŸ˜­ã€‚æ¥çœ‹çœ‹ä»Šå¤©å®‰æ’ï¼šäº‹åŠ¡ç®¡ç†ï¼Œæ–‡ä»¶ä¸Šä¼ ï¼Œå‘˜å·¥çš„åˆ é™¤å’Œä¿®æ”¹ã€‚

## æ—¥ç¨‹
äº”ç‚¹ï¼Œçœ‹å®Œäº‹åŠ¡ç®¡ç†ï¼Œå»æ°é¥­ä¹‹å‰æŠŠblogå†™å†™ã€‚  
ç°åœ¨æ˜¯8ï¼š30ï¼Œçƒ¦èºï¼Œéå¸¸çƒ¦èºï¼Œå†³å®šå…ˆå»æ´—ä¸ªæ¾¡ï¼Œå› ä¸ºçƒ¦èºå½±å“æ³¨æ„åŠ›ï¼Œå…ˆæŠŠblogå†™äº†ã€‚  
å¥½åƒå†™äº†ä¼šblogåˆæ²¡é‚£ä¹ˆç‡¥äº†ï¼ŒçœŸå¥‡æ€ªå“ˆã€‚  
11ç‚¹10åˆ†ï¼Œæ¥æ”¶ä¸ªå°¾ã€‚

## å­¦ä¹ å†…å®¹

### çœæµï¼š
1. Spring äº‹åŠ¡ç®¡ç†
2. æ–‡ä»¶ä¸Šä¼ 
3. è‡ªå®šä¹‰ç»“æœé›†
4. é€†å¤© Bug

### 1. Spring äº‹åŠ¡ç®¡ç†
Spring æä¾›äº†æ–¹ä¾¿çš„äº‹åŠ¡ç®¡ç†æ³¨è§£ `@Transactional`ï¼Œå®ƒå¯ä»¥ä½œç”¨åœ¨æ–¹æ³•ã€ç±»ï¼Œæˆ–è€…æ¥å£ä¸Šï¼ˆå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œä¸€èˆ¬ä½œç”¨åœ¨æ–¹æ³•ä¸Šï¼‰ã€‚

é€šè¿‡é…ç½®å¯ä»¥æŸ¥çœ‹ Spring äº‹åŠ¡çš„åº•å±‚æ—¥å¿—ï¼š
```yaml
logging:
  level:
    org.springframework.jdbc.support.JdbcTransactionManager: debug
```

- **rollbackFor**ï¼šç”¨äºæ§åˆ¶æŠ›å‡ºä½•ç§å¼‚å¸¸æ—¶å¯¹äº‹åŠ¡è¿›è¡Œå›æ»šï¼ˆé»˜è®¤æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ `RuntimeException`ï¼‰ã€‚  
  ä¾‹å¦‚ï¼š
  ```java
  @Transactional(rollbackFor = Exception.class) // è®¾ç½®ä¸ºæ‰€æœ‰å¼‚å¸¸
  ```

- **propagation**ï¼šæ§åˆ¶äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º  
  | å±æ€§å€¼         | å«ä¹‰                                       |  
  |----------------|--------------------------------------------|  
  | REQUIRED       | ã€é»˜è®¤å€¼ã€‘éœ€è¦äº‹åŠ¡ï¼Œæœ‰åˆ™åŠ å…¥ï¼Œæ— åˆ™åˆ›å»ºæ–°äº‹åŠ¡ |  
  | REQUIRES_NEW   | éœ€è¦æ–°äº‹åŠ¡ï¼Œæ— è®ºæœ‰æ— ï¼Œæ€»æ˜¯åˆ›å»ºæ–°äº‹åŠ¡       |  
  | SUPPORTS       | æ”¯æŒäº‹åŠ¡ï¼Œæœ‰åˆ™åŠ å…¥ï¼Œæ— åˆ™åœ¨æ— äº‹åŠ¡çŠ¶æ€ä¸­è¿è¡Œ   |  
  | NOT_SUPPORTED  | ä¸æ”¯æŒäº‹åŠ¡ï¼Œåœ¨æ— äº‹åŠ¡çŠ¶æ€ä¸‹è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨å·²æœ‰äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ |  
  | MANDATORY      | å¿…é¡»æœ‰äº‹åŠ¡ï¼Œå¦åˆ™æŠ›å¼‚å¸¸                       |  
  | NEVER          | å¿…é¡»æ²¡äº‹åŠ¡ï¼Œå¦åˆ™æŠ›å¼‚å¸¸                       |  

  ä¾‹å¦‚ï¼š
  ```java
  @Transactional(rollbackFor = Exception.class)
  @Override
  public void save(Emp emp) {
      try {
          //......äº‹åŠ¡çš„å¤„ç†
      } finally {
          //è®°å½•æ“ä½œæ—¥å¿—
          EmpLog empLog = new EmpLog(null,LocalDateTime.now(),"æ–°å¢å‘˜å·¥" + emp);
          empLogService.insertLog(empLog);
      }
  }
  ```

### 2. æ–‡ä»¶ä¸Šä¼ 
å‰ç«¯è¦æ±‚ï¼šæ³¨æ„ `method="post"`ï¼Œ`enctype="multipart/form-data"` å’Œ `<input type="file" name="file">` æ˜¯å¿…é¡»çš„ã€‚
```html
<form action="/upload" method="post" enctype="multipart/form-data">
    å§“å: <input type="text" name="name"><br>
    å¹´é¾„: <input type="text" name="age"><br>
    å¤´åƒ: <input type="file" name="file"><br>
    <input type="submit" value="æäº¤">
</form>
```

#### å°†æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°
```java
@PostMapping("/upload")
public Result handleFileUpload(String name, Integer age, MultipartFile file) throws IOException {
    log.info("æ–‡ä»¶ä¸Šä¼ :{}{}{}",name,age,file);
    //è·å–åŸå§‹æ–‡ä»¶å
    String fileName =  file.getOriginalFilename();

    //UUIDç”Ÿæˆæ–°çš„æ–‡ä»¶å
    String extension = fileName.substring(fileName.lastIndexOf("."));
    fileName = UUID.randomUUID().toString()+extension;

    //ä¿å­˜åœ¨æœ¬åœ°ç›®å½•
    file.transferTo(new File("C:\\Desktop\\" + fileName));

    return Result.success();
}
```

#### ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS
[é˜¿é‡Œäº‘ç™»å½• - æ¬¢è¿ç™»å½•é˜¿é‡Œäº‘ï¼Œå®‰å…¨ç¨³å®šçš„äº‘è®¡ç®—æœåŠ¡å¹³å°](https://oss.console.aliyun.com)  
æ­¥éª¤ï¼š
```mermaid
graph LR
    A[æ³¨å†Œé˜¿é‡Œäº‘<br>ï¼ˆå®åè®¤è¯ï¼‰] --> c[å¼€é€šå¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆOSSï¼‰]
    C --> D[åˆ›å»ºbucket]
    D --> E[è·å–å¹¶é…ç½®<br>AccessKeyï¼ˆç§˜é’¥ï¼‰]
    E --> F[å‚ç…§å®˜æ–¹SDK<br>ç¼–å†™å…¥é—¨ç¨‹åº]
    F --> G[æ¡ˆä¾‹é›†æˆOSS]
```

1. **å…³äºåˆ›å»ºbucket**  
   ä¸ºäº†ä»£ç†æœåŠ¡å™¨èƒ½å¤Ÿæ­£å¸¸è·å–å›¾ç‰‡ï¼Œéœ€è¦ä¿®æ”¹bucketä¸­çš„æƒé™æ§åˆ¶ã€‚

2. **è·å–å¹¶é…ç½® AccessKey**  
   åœ¨é˜¿é‡Œäº‘è·å– AccessKey åï¼Œé…ç½®ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€‚  
   ç”¨ç®¡ç†å‘˜æ¨¡å¼æ‰“å¼€cmdï¼ˆäº²æµ‹è¿™ç§æ–¹å¼ï¼‰ï¼Œè¾“å…¥ï¼š
   ```cmd
   set OSS_ACCESS_KEY_ID=ã€ä½ çš„keyidã€‘
   set OSS_ACCESS_KEY_SECRET=ã€ä½ çš„keysecretã€‘
   setx OSS_ACCESS_KEY_ID "%OSS_ACCESS_KEY_ID%"
   setx OSS_ACCESS_KEY_SECRET "%OSS_ACCESS_KEY_SECRET%"
   ```
   æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆï¼š
   ```cmd
   echo %OSS_ACCESS_KEY_ID%
   echo %OSS_ACCESS_KEY_SECRET%
   ```
   å¦‚æœè¿”å›äº† AccessKeyï¼Œè¯´æ˜é…ç½®æˆåŠŸã€‚

3. **å…¥é—¨ç¨‹åº**  
   è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[OSS Java SDKå¿«é€Ÿå…¥é—¨](https://help.aliyun.com/zh/oss/developer-reference/getting-started?spm=a2c4g.11186623.0.i1)  
   å¯¼å…¥ä¾èµ–åŠå…¥é—¨ç¨‹åºï¼ˆçœç•¥äº†ï¼Œè¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼‰ï¼š
   ```xml
   <dependency>
       <groupId>com.aliyun.oss</groupId>
       <artifactId>aliyun-sdk-oss</artifactId>
       <version>3.17.4</version>
   </dependency>
   ```

   é…ç½®ä¸Šä¼ æ–‡ä»¶çš„æ ¼å¼å¹¶è¿›è¡Œæµ‹è¯•ï¼š
   ```java
   //ä¸Šä¼ æ–‡ä»¶
   String objectName = "C:\\Desktop\\1.png";
   File file = new File(objectName);
   byte[] bytes = Files.readAllBytes(file.toPath());
   ossClient.putObject(bucketName, objectName, new ByteArrayInputStream(bytes));
   ```

4. **æ¡ˆä¾‹é›†æˆ OSS**  
   å°†å®˜æ–¹çš„å…¥é—¨ç¨‹åºä¿®æ”¹åŒ…è£…ä¸ºå·¥å…·ç±»ï¼š
   ```java
   @Component
   public class AliyunOSSOperator {
       @Autowired
       private AliyunOSSProperties aliyunOSSProperties; //å‚æ•°çš„é…ç½®åŒ–

       public String upload(byte[] content, String originalFilename) throws Exception {
           String endpoint = aliyunOSSProperties.getEndpoint();
           String bucketName = aliyunOSSProperties.getBucketName();
           String region = aliyunOSSProperties.getRegion();

           // ä»ç¯å¢ƒå˜é‡ä¸­è·å–è®¿é—®å‡­è¯ã€‚è¿è¡Œæœ¬ä»£ç ç¤ºä¾‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²è®¾ç½®ç¯å¢ƒå˜é‡OSS_ACCESS_KEY_IDå’ŒOSS_ACCESS_KEY_SECRETã€‚
           EnvironmentVariableCredentialsProvider credentialsProvider = CredentialsProviderFactory.newEnvironmentVariableCredentialsProvider();

           // å¡«å†™Objectå®Œæ•´è·¯å¾„ï¼Œä¾‹å¦‚202406/1.pngã€‚Objectå®Œæ•´è·¯å¾„ä¸­ä¸èƒ½åŒ…å«Bucketåç§°ã€‚
           //è·å–å½“å‰ç³»ç»Ÿæ—¥æœŸçš„å­—ç¬¦ä¸²,æ ¼å¼ä¸º yyyy/MM
           String dir = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy/MM"));
           //ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¸é‡å¤çš„æ–‡ä»¶å
           String newFileName = UUID.randomUUID() + originalFilename.substring(originalFilename.lastIndexOf("."));
           String objectName = dir + "/" + newFileName;

           // åˆ›å»ºOSSClientå®ä¾‹ã€‚
           ClientBuilderConfiguration clientBuilderConfiguration = new ClientBuilderConfiguration();
           clientBuilderConfiguration.setSignatureVersion(SignVersion.V4);
           OSS ossClient = OSSClientBuilder.create()
                   .endpoint(endpoint)
                   .credentialsProvider(credentialsProvider)
                   .clientConfiguration(clientBuilderConfiguration)
                   .region(region)
                   .build();

           try {
               ossClient.putObject(bucketName, objectName, new ByteArrayInputStream(content));
           } finally {
               ossClient.shutdown();
           }
           //æ ¹æ®aliyunossçš„urlçš„ç‰¹ç‚¹è¿›è¡Œæ‹¼æ¥è¿”å›
           return endpoint.split("//")[0] + "//" + bucketName + "." + endpoint.split("//")[1] + "/" + objectName;
       }
   }
   ```

5. **å‚æ•°çš„é…ç½®åŒ–**  
   å¯ä»¥å°†å‚æ•°å†™åˆ° yml é…ç½®æ–‡ä»¶ä¸­ï¼Œå†é€šè¿‡ `@Value` æ³¨è§£è¿›è¡Œæ³¨å…¥ï¼š
   ```yaml
   aliyun:
     oss:
       endpoint: https://oss-cn-guangzhou.aliyuncs.com
       bucket-name: ã€your bucket-nameã€‘
       region: cn-guangzhou
   ```

   æ³¨è§£éƒ¨åˆ†ï¼š
   ```java
   @Value("${aliyun.oss.endpoint}")
   private String endpoint;
   @Value("${aliyun.oss.bucket-name}")
   private String bucketName;
   @Value("${aliyun.oss.region}")
   private String region;
   ```

   å¦‚æœå‚æ•°æ¯”è¾ƒå¤šï¼Œå¯ä»¥è€ƒè™‘ç”¨ `@ConfigurationProperties` æ˜ å°„åˆ°ä¸€ä¸ªåŒ…è£…ç±»ä¸­ï¼š
   ```java
   @Data
   @AllArgsConstructor
   @NoArgsConstructor
   @Component
   @ConfigurationProperties(prefix = "aliyun.oss")
   public class AliyunOSSProperties {
       private String endpoint;
       private String bucketName;
       private String region;
   }
   ```

   é€šè¿‡ä¾èµ–æ³¨å…¥ beanï¼š
   ```java
   @Autowired
   private AliyunOSSProperties aliyunOSSProperties; //å‚æ•°çš„é…ç½®åŒ–
   ```

### 3. è‡ªå®šä¹‰ç»“æœé›†
å½“è‡ªåŠ¨åŒ–æ˜ å°„æ— æ³•å¤„ç†è¾ƒå¤æ‚æƒ…å†µæ—¶ï¼Œç”¨æ‰‹åŠ¨æ˜ å°„è¡¨ï¼š
```xml
<!-- è‡ªå®šä¹‰ç»“æœé›† -->
<resultMap id="empResultMap" type="com.itheima.pojo.Emp">
    <id column="id" property="id"/>
    <result column="username" property="username"/>
    <result column="password" property="password"/>
    <result column="name" property="name"/>
    <result column="gender" property="gender"/>
    <result column="phone" property="phone"/>
    <result column="job" property="job"/>
    <result column="salary" property="salary"/>
    <result column="image" property="image"/>
    <result column="entry_date" property="entryDate"/>
    <result column="dept_id" property="deptId"/>
    <result column="create_time" property="createTime"/>
    <result column="update_time" property="updateTime"/>
    <!-- å°è£…exprList -->
    <collection property="exprList" ofType="com.itheima.pojo.EmpExpr">
        <id column="ee_id" property="id"/>
        <result column="ee_empid" property="empId"/>
        <result column="ee_begin" property="begin"/>
        <result column="ee_end" property="end"/>
        <result column="ee_company" property="company"/>
        <result column="ee_job" property="job"/>
    </collection>
</resultMap>

<!--è°ƒç”¨è‡ªå®šä¹‰ç»“æœé›†-->
<select id="getInfoById" resultMap="empResultMap">
    select
    e.*,
    ee.id ee_id,
    ee.emp_id ee_empid,
    ee.begin ee_begin,
    ee.end ee_end,
    ee.company ee_company,
    ee.job ee_job
    from emp e left join emp_expr ee on e.id = ee.emp_id
    where e.id = #{id};
</select>
```

### 4. é€†å¤© Bug
ps: æœç„¶åªæœ‰è‡ªå·±å†™ä¸œè¥¿æ‰èƒ½æš´éœ²é—®é¢˜  
1. `@RequestParam` è¦æ±‚è¯·æ±‚å­—æ®µå’Œæ¥æ”¶çš„å­—æ®µåç›¸åŒï¼Œä¸è¦å†å¿˜è®°äº†ï¼  
2. è·å–è¿”å›è·¯å¾„çš„å­—æ®µ `/emps/{id}` åº”è¯¥ç”¨ `@PathVariable` è€Œä¸æ˜¯ `@RequestParam`ã€‚  
3. `<if test="updateTime != null">update_time = #{updateTime},</if>` `test` å±æ€§éœ€è¦å¼•ç”¨å®ä½“ç±»çš„å±æ€§åï¼Œè€Œä¸æ˜¯æ•°æ®åº“çš„å­—æ®µåï¼  
4. æŠŠåˆ é™¤è¡¨å• SQL é‡Œçš„ `emp_expr` å†™æˆäº† `emp`ï¼Œæ€ªä¸å¾—ä¿®æ”¹ä¸€ä¸ªæ²¡ä¸€ä¸ªï¼Œç»™è‡ªå·±æ°”ç¬‘äº†ï¼Œå†ä¹Ÿä¸åœ¨ copy çš„æ—¶å€™å·æ‡’äº†ğŸ˜­ï¼Œå†ä¹Ÿä¸å·æ‡’ä¸çœ‹è‡ªåŠ¨è¡¥å…¨çš„å†…å®¹äº†ğŸ˜­ğŸ˜¡

## ç»“è¯­
æœ€è¿‘åœ¨å¬è‰ä¸œçš„ã€Šå±±æµ·ã€‹ï¼Œè¶Šå¬è¶Šå¥½å¬å§ï¼ŒåŸæ¥ä¸æ˜¯â€œå¥¹æ˜ç™½â€ï¼Œä¹Ÿä¸æ˜¯â€œä»–æ˜ç™½â€ï¼Œè€Œæ˜¯â€œæˆ‘æ˜ç™½â€ã€‚  
å¦‚æœå½“åˆé€‰æ‹©çš„æ˜¯å¦å¤–ä¸€æ¡è·¯ä¼šæ€ä¹ˆæ ·ï¼Ÿå¯æƒœæˆ‘å¯ä»¥è½¬èº«ï¼Œä½†ä¸èƒ½å›å¤´ã€‚  
**æ—¢é•¿è·¯ä¸è§å½’é€”ï¼Œä¾¿æ¥å¯»ç°å»å¾€ã€‚**
