# æˆ‘çš„å¼€å‘æ—¥å¿—ï¼šç±»è·¯å¾„æ‰«æã€DI å®¹å™¨ä¸åŠ¨æ€ä»£ç†

## å‰è¨€
----------------------------------------
æˆ‘å¤±å¿†äº†ï¼Œå®Œå…¨ä¸è®°å¾—è‡ªå·±æ—©ä¸Šå¹²äº†ä»€ä¹ˆã€‚

----------------------------------------

## æ—¥ç¨‹
----------------------------------------
æ—©ä¸Š 10 ç‚¹å·¦å³å¼€å§‹ï¼Œå­¦äº†ä¸€æ—©ä¸Šï¼Œä¸»è¦æ˜¯ç±»è·¯å¾„æ‰«æç›¸å…³çš„è°ƒè¯•ã€‚  
æ™šä¸Š 8 ç‚¹äº†ï¼ŒçœŸä¸èƒ½å†æ‘¸ğŸŸäº†ã€‚

----------------------------------------

## å­¦ä¹ è®°å½•
----------------------------------------
è®¡ç®—æœºç½‘ç»œï¼š
1. å­ç½‘åˆ’åˆ†ä¸å­ç½‘æ©ç 

----------------------------------------

## å­¦ä¹ å†…å®¹
----------------------------------------
### çœæµ
1. æ‰‹æ“ç±»è·¯å¾„æ‰«æå™¨
2. æ‰‹æ“åŸºç¡€ DI å®¹å™¨
3. åŠ¨æ€ä»£ç†

### 1. æ‰‹æ“ç±»è·¯å¾„æ‰«æå™¨
1ï¼‰é¦–å…ˆè¦ç¡®å®šéœ€è¦æ‰«æçš„åŒ…
```java
String path = packageName.replace('.', '/');
```

2ï¼‰ç„¶åè·å–ç³»ç»Ÿç±»åŠ è½½å™¨è·å–è·¯å¾„ï¼Œå¹¶è·å–è¯¥è·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æº
```java
ClassLoader classLoader = ClassLoader.getSystemClassLoader();
Enumeration<URL> resources = classLoader.getResources(path);
```
**æ³¨æ„**ï¼šç³»ç»Ÿç±»åŠ è½½å™¨ (`ClassLoader.getSystemClassLoader()`) çš„æ‰«æèŒƒå›´åŒ…æ‹¬æ‰€æœ‰åœ¨ JVM å¯åŠ¨æ—¶é€šè¿‡ `-classpath` æˆ– `-cp` æŒ‡å®šçš„è·¯å¾„ï¼ˆåŒ…æ‹¬ Maven/Gradle ä¾èµ–ï¼‰ã€‚

3ï¼‰éå†æ‰€æœ‰çš„èµ„æºï¼Œé€šè¿‡ `resource.getProtocol()` è·å– URL å¯¹è±¡çš„åè®®ç±»å‹ï¼Œè·å– URL å¯¹è±¡çš„ç±»æ–‡ä»¶
```java
while (resources.hasMoreElements()){
    URL resource = resources.nextElement();
    if (resource.getProtocol().equals("file")) {
        classes.addAll(findClasses(new File(resource.getFile()), packageName, classFilter));
    }
}
```
->è¿›å…¥ `findClasses` æ–¹æ³•

4ï¼‰è·å–æ–‡ä»¶åˆ—è¡¨ï¼Œéå†æ–‡ä»¶å’Œå­ç›®å½•ï¼Œè·å– `clazz` å¯¹è±¡ï¼Œå¹¶è¿”å› `List<Class<?>> classes` åˆ—è¡¨
```java
File[] files = directory.listFiles();          
for (File file : files) {
    if (file.isDirectory()) {
        String subPackage = packageName + "." + file.getName();
        classes.addAll(findClasses(file, subPackage, classFilter));
    } else if (file.getName().endsWith(".class")) {
        String className = packageName + '.' +
                file.getName().substring(0, file.getName().length() - 6); //è·å–classå…¨ç±»å
        Class<?> clazz = Class.forName(className, false, Thread.currentThread().getContextClassLoader()); //æ ¹æ®å…¨ç±»åæ‰¾åˆ°clazzå¯¹è±¡(ä¸å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–)
        if (classFilter.test(clazz)) { //è¿‡æ»¤å™¨æ£€æŸ¥
            classes.add(clazz);
        }
    }
}
return classes;
```

5ï¼‰æä¾›äº†ä¸€ä¸ªæ‰«æå«æœ‰å¯¹åº”æ³¨è§£çš„ç±»
```java
public static List<Class<?>> scanClassesWithAnnotation(String packageName,Class<? extends java.lang.annotation.Annotation> annotation) {
    return scanClasses(packageName, clazz -> clazz.isAnnotationPresent(annotation));
}
```
`Class<? extends java.lang.annotation.Annotation>` è¡¨ç¤ºæ¥æ”¶çš„ `Class` å¯¹è±¡æ˜¯ `java.lang.annotation.Annotation` çš„ä»»æ„å­ç±»ã€‚

### 2. æ‰‹æ“åŸºç¡€ DI å®¹å™¨

#### 0ï¼‰ç”¨ map æ¥å‚¨å­˜æ˜ å°„ï¼Œåœ¨åˆ›å»ºç±»å¯¹è±¡æ—¶è¿›è¡Œæ‰«æ
```java
// å­˜å‚¨ç±»å®šä¹‰çš„æ˜ å°„ï¼ˆç±»å -> ç±»å¯¹è±¡ï¼‰
private final Map<String, Class<?>> classRegistry = new HashMap<>();
// å­˜å‚¨å•ä¾‹å®ä¾‹çš„æ˜ å°„ï¼ˆç±»å -> å®ä¾‹ï¼‰
private final Map<String, Object> singletonInstances = new HashMap<>();
// æ­£åœ¨åˆ›å»ºçš„Beanè®°å½•ï¼ˆç”¨äºè§£å†³å¾ªç¯ä¾èµ–ï¼‰
private final Set<String> beansInCreation = new HashSet<>();
//æ¥å£åˆ°å®ç°ç±»çš„æ˜ å°„
private final Map<Class<?>, Class<?>> interfaceToImplementation = new HashMap<>();
// åŒ…æ‰«æè·¯å¾„
private final String basePackage;

public ContainerFactory(String basePackage) {
    this.basePackage = basePackage;
    scanComponents();
    initializeInterfaceLinks();
    initializeSingletons();
}
```

#### 1ï¼‰ç»„ä»¶æ‰«æ
```java
private void scanComponents() {
    List<Class<?>> componentClasses = ClassPathScanner.scanClassesWithAnnotation(
            basePackage, KatComponent.class);

    for (Class<?> clazz : componentClasses) {
        register(clazz);
    }
}
```
-> è¿›å…¥ `register` æ–¹æ³•

#### 2ï¼‰æ³¨å†Œç»„ä»¶
```java
public void register(Class<?> clazz) {
    if (clazz.isAnnotationPresent(KatComponent.class)) {
        String beanName = getBeanName(clazz);
        classRegistry.put(beanName, clazz);
    }
}
```
// è·å–Beanåç§°
```java
private String getBeanName(Class<?> clazz) {
    KatComponent component = clazz.getAnnotation(KatComponent.class);
    return component.value().isEmpty() ? clazz.getSimpleName() : component.value(); //æ³¨è§£æ²¡æœ‰æŒ‡å®šBeanåç§°æ—¶ï¼Œä»¥ç±»åä½œä¸ºBeanåç§°
}
```

#### 3ï¼‰å¯¹å•ä¾‹ Bean è¿›è¡Œåˆå§‹åŒ–
```java
// åˆå§‹åŒ–æ‰€æœ‰å•ä¾‹Bean
private void initializeSingletons() {
    for (Map.Entry<String, Class<?>> entry : classRegistry.entrySet()) {
        Class<?> clazz = entry.getValue();
        if (clazz.isAnnotationPresent(KatSingleton.class)) {
            getBean(clazz); // è§¦å‘å•ä¾‹åˆå§‹åŒ–
        }
    }
}
```
->è¿›å…¥ `getBean` æ–¹æ³•

#### 4ï¼‰è·å– Bean å®ä¾‹
è¿™é‡Œé‡‡ç”¨äº†ä¾èµ–æ³¨å…¥æ¥å£æ¨¡å¼ï¼Œæ‰€ä»¥è¦ä»æ¥å£ç´¢å¼•ä¸­è·å–å¯¹åº”çš„å®ç°ç±»
```java
// è·å–Beanå®ä¾‹(æ¥å£æ˜ å°„)
@SuppressWarnings("unchecked") //å¿½ç•¥æ³›å‹è­¦å‘Š
public <T> T getBean(Class<T> interfaceType) {
    //æ¥å£æ¨¡å¼
    Class<?> implementationClass = interfaceToImplementation.get(interfaceType); 
    if (implementationClass == null) {
        throw new RuntimeException("No implementation found for " + interfaceType);
    }
    return (T) getBean(getBeanName(implementationClass), implementationClass);
}
```
//åˆå§‹åŒ–æ¥å£ç´¢å¼•
```java
private void initializeInterfaceLinks() {
    for (Class<?> clazz : classRegistry.values()) {
        for (Class<?> intf : clazz.getInterfaces()) {
            if (!interfaceToImplementation.containsKey(intf)) {
                interfaceToImplementation.put(intf, clazz);
            }
        }
    }
}
```

-->è¿›å…¥å®ç°ç±» Bean åˆ›å»º

```java
@SuppressWarnings("unchecked") //å¿½ç•¥æ³›å‹è­¦å‘Š
public <T> T getBean(String beanName, Class<T> clazz) {
    // æ£€æŸ¥å•ä¾‹ç¼“å­˜
    if (singletonInstances.containsKey(beanName)) {
        return (T) singletonInstances.get(beanName);
    }

    // æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
    if (!classRegistry.containsKey(beanName)) {
        throw new RuntimeException("Bean not registered: " + beanName);
    }

    // æ£€æŸ¥å¾ªç¯ä¾èµ–
    if (beansInCreation.contains(beanName)) {
        throw new RuntimeException("Circular dependency detected for bean: " + beanName);
    }

    beansInCreation.add(beanName);
    try {
        Class<?> targetClass = classRegistry.get(beanName);
        Object instance = createInstance(targetClass); //åˆ›å»ºå®ä¾‹

        // å¦‚æœæ˜¯å•ä¾‹åˆ™ç¼“å­˜
        if (targetClass.isAnnotationPresent(KatSingleton.class)) {
            singletonInstances.put(beanName, instance);
        }

        return (T) instance;
    } catch (Exception e) {
        throw new RuntimeException("Failed to create bean: " + beanName, e);
    } finally {
        beansInCreation.remove(beanName);
    }
}
```

--->è¿›å…¥ `createInstance` æ–¹æ³•

#### 5ï¼‰åˆ›å»ºå®ä¾‹
```java
private Object createInstance(Class<?> clazz) throws Exception {
    // 1. ä¼˜å…ˆä½¿ç”¨@KatAutowiredæ„é€ å™¨
    Constructor<?> autowiredCtor = findAutowiredConstructor(clazz);
    if (autowiredCtor != null) {
        return createInstanceWithConstructor(autowiredCtor);
    }

    // 2. ä½¿ç”¨é»˜è®¤æ— å‚æ„é€ å™¨
    try {
        Object instance = clazz.getDeclaredConstructor().newInstance();
        injectFields(instance);
        return instance;
    } catch (NoSuchMethodException e) {
        throw new RuntimeException("No suitable constructor found for " + clazz.getName());
    }
}
```

---->è¿›å…¥ `findAutowiredConstructor` æ–¹æ³•

```java
// æŸ¥æ‰¾@KatAutowiredæ„é€ å™¨
private Constructor<?> findAutowiredConstructor(Class<?> clazz) {
    Constructor<?>[] ctors = clazz.getConstructors();
    for (Constructor<?> ctor : ctors) {
        if (ctor.isAnnotationPresent(KatAutowired.class)) {
            return ctor;
        }
    }
    return null;
}
```

---->è¿›å…¥ `createInstanceWithConstructor` æ–¹æ³•

```java
// ä½¿ç”¨æ„é€ å™¨åˆ›å»ºå®ä¾‹
private Object createInstanceWithConstructor(Constructor<?> ctor) throws Exception {
    Class<?>[] paramTypes = ctor.getParameterTypes(); //è·å–å‚æ•°
    Object[] args = new Object[paramTypes.length];

    for (int i = 0; i < paramTypes.length; i++) { //æ·»åŠ å‚æ•°
        args[i] = getBean(paramTypes[i]);
    }

    Object instance = ctor.newInstance(args); //åˆ›å»ºå®ä¾‹
    injectFields(instance); //æ³¨å…¥ä¾èµ–å­—æ®µ
    return instance;
}
```

----->è¿›å…¥ `injectFields` æ–¹æ³•

```java
// æ³¨å…¥å­—æ®µä¾èµ–
private void injectFields(Object instance) throws IllegalAccessException {
    Class<?> clazz = instance.getClass();
    //éå†ç›®æ ‡ç±»çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ç§æœ‰å­—æ®µï¼‰
    for (Field field : clazz.getDeclaredFields()) {
        // æ£€æŸ¥å­—æ®µæ˜¯å¦è¢«@KatAutowiredæ³¨è§£æ ‡æ³¨
        if (field.isAnnotationPresent(KatAutowired.class)) {
            Object dependency = getBean(field.getType());
            field.setAccessible(true); //å…è®¸è®¿é—®ç§æœ‰å­—æ®µ
            field.set(instance, dependency); //æ³¨å…¥ç›®æ ‡å­—æ®µ
        }
    }
}
```

ç›®å‰åªæ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ç‰ˆæœ¬ï¼Œå¤„ç†ä¸äº†å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œæ•´ä½“æ•ˆç‡ä¹Ÿæ¯”è¾ƒä½ã€‚  
æ˜å¤©è€ƒè™‘å…¼å®¹åŠ¨æ€ä»£ç†ï¼Œå¤šè·¯å¾„æ‰«æï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½ï¼‰ã€‚

### 3. åŠ¨æ€ä»£ç†
åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†ç±»å’Œå¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶é™æ€å®šä¹‰ã€‚å®ƒå¯¹äºä¾èµ–æ³¨å…¥åçš„äº‹åŠ¡å®ç°ä»¥åŠ AOP éå¸¸é‡è¦ã€‚

#### 1ï¼‰åŸç†åˆ†æ
ä»¥ `InvocationHandler` ä¸ºä¾‹  
`InvocationHandler` æ˜¯ Java åŠ¨æ€ä»£ç†æœºåˆ¶ä¸­çš„æ ¸å¿ƒæ¥å£ï¼Œå®ƒå®šä¹‰äº†ä»£ç†å¯¹è±¡æ–¹æ³•è°ƒç”¨çš„è½¬å‘é€»è¾‘ã€‚
```java
public interface InvocationHandler {
    public Object invoke(Object proxy, Method method, Object[] args)
        throws Throwable;
}
```
- `proxy`ï¼šåŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡å®ä¾‹
- `method`ï¼šè¢«è°ƒç”¨çš„æ–¹æ³•å¯¹è±¡
- `args`ï¼šæ–¹æ³•è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æ•°ç»„

ä½¿ç”¨ç¤ºä¾‹ï¼š
```java
class DebugInvocationHandler implements InvocationHandler {
    private final Object target;
    public DebugInvocationHandler(Object target) {
        this.target = target;
    }   
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // æ–¹æ³•è°ƒç”¨å‰é€»è¾‘
        System.out.printf("è°ƒç”¨æ–¹æ³•: %sï¼Œå‚æ•°: %s%n", 
                         method.getName(), 
                         Arrays.toString(args));
        
        // è°ƒç”¨çœŸå®å¯¹è±¡çš„æ–¹æ³•
        Object result = method.invoke(target, args);

        // æ–¹æ³•è°ƒç”¨åé€»è¾‘
        System.out.printf("æ–¹æ³• %s è°ƒç”¨å®Œæˆï¼Œç»“æœ: %s%n", 
                         method.getName(), 
                         result);
        return result;
    }
}

public static void main(String[] args) {
    RealSubject real = new RealSubject(); //çœŸå®çš„å¯¹è±¡
    //åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡
    Subject proxy = (Subject) Proxy.newProxyInstance(
            Subject.class.getClassLoader(),
            new Class[]{Subject.class},
            new DebugInvocationHandler(real)
    );
    //ä»£ç†å¯¹è±¡.method() â†’ InvocationHandler.invoke() â†’ çœŸå®å¯¹è±¡.method()
    proxy.request();
}
```

----------------------------------------

## ç»“è¯­
----------------------------------------
å¤§è„‘å·²ç»å®•æœºã€‚

---------------------------------------