# æˆ‘çš„é‡ç”Ÿå¼€å‘ä¹‹æ—…ï¼šä¼˜åŒ–DIå®¹å™¨ï¼Œgitæäº¤è§„èŒƒï¼ŒAOPå¤„ç†å™¨ï¼Œé”ä¸å¹¶å‘å®‰å…¨

## å‰è¨€
----------------------------------------
æˆ‘é‡ç”Ÿäº†ï¼Œé‡ç”Ÿåˆ°äº†äº”ä¸€å¼€å§‹çš„ä¸€å¤©ã€‚ä¸Šä¸€ä¸–ï¼Œæˆ‘å¤©å¤©æ‘†çƒ‚ï¼Œæœ€åæƒ¨é­å®ä¹ ç”Ÿä¼˜åŒ–ã€‚è¿™ä¸€ä¸–ï¼Œæˆ‘è¦å¥½å¥½å†…å·.....

ä»Šå¤©çš„ç›®æ ‡æ˜¯ç»§ç»­ä¼˜åŒ–DIå®¹å™¨çš„åŠŸèƒ½ï¼Œå°è¯•å…¼å®¹AOPï¼Œå¹¶ç®€å•åšä¸€ä¸ªåç«¯è”è°ƒæµ‹è¯•ã€‚

----------5.2-----------
ä»Šå¤©ç»§ç»­å®Œå–„DIå®¹å™¨ï¼Œå¦‚æœæœ‰æ—¶é—´å°±ç ”ç©¶ä¸€ä¸‹å¤šçº¿ç¨‹ã€‚

----------------------------------------

## æ—¥ç¨‹
----------------------------------------
8ç‚¹ï¼Œèµ·çš„æœ€æ—©çš„ä¸€é›†ã€‚  
è¢«ç±»åŠ è½½å™¨é—®é¢˜å¡äº†ä¸€ä¸‹åˆï¼Œæ™šä¸Šå…ˆæ‘¸æ‘¸ğŸŸï¼Œçœ‹çœ‹gitæäº¤çš„è§„èŒƒ  
æ™šä¸Š9ç‚¹ï¼Œä¸æ‘¸äº†ä¸æ‘¸äº†  
å‡Œæ™¨1ç‚¹äº†ï¼Œè¢«AOPé€¼ç–¯äº†ã€‚  

----------5.2-----------  
å¼„äº†ä¸€æ—©ä¸Šï¼Œå¯ç®—æŠŠAOPå¼„å‡ºæ¥äº†ï¼Œä¸‹åˆå†™å†™ä»£ç åˆ†æ  
æ™šä¸Šå¿«8ç‚¹äº†ï¼Œæ¥çœ‹çœ‹å¤šçº¿ç¨‹é—®é¢˜  

----------------------------------------


## å­¦ä¹ å†…å®¹
----------------------------------------
### çœæµï¼š
1. ä¼˜åŒ–DIå®¹å™¨
2. ç±»åŠ è½½å™¨éš”ç¦»é—®é¢˜å’Œç±»åŠ è½½å™¨æ¡¥æ¥
3. å…³äºgitæäº¤çš„ä¸€äº›è§„èŒƒ
4. æ‰‹æ“AOPå¤„ç†å™¨
5. é”ä¸å¹¶å‘å®‰å…¨

### 1. ä¼˜åŒ–DIå®¹å™¨
å…ˆæ¥çœ‹çœ‹ç°åœ¨å­˜åœ¨çš„é—®é¢˜ï¼š
1. **å¾ªç¯ä¾èµ–å¤„ç†ä¸è¶³**ï¼š
   - å½“å‰å®ç°åªèƒ½æ£€æµ‹å¾ªç¯ä¾èµ–ï¼Œä½†æ²¡æœ‰è§£å†³å®ƒï¼ˆæ¯”å¦‚é€šè¿‡ä¸‰çº§ç¼“å­˜ï¼‰ã€‚
   - å¯¹äºæ„é€ å™¨æ³¨å…¥çš„å¾ªç¯ä¾èµ–æ— æ³•å¤„ç†ã€‚

2. **ä½œç”¨åŸŸæ”¯æŒæœ‰é™**ï¼š
   - åªæœ‰å•ä¾‹(Singleton)å’ŒåŸå‹(æœªæ ‡æ³¨æ—¶)ä¸¤ç§ä½œç”¨åŸŸã€‚
   - ç¼ºå°‘request/sessionç­‰å…¶ä»–å¸¸ç”¨ä½œç”¨åŸŸã€‚

3. **æ¥å£æ˜ å°„é—®é¢˜**ï¼š
   - ä¸€ä¸ªæ¥å£åªèƒ½æœ‰ä¸€ä¸ªå®ç°ç±»ï¼ˆç¬¬ä¸€ä¸ªé‡åˆ°çš„ä¼šè¢«ä¿ç•™ï¼‰ã€‚
   - æ²¡æœ‰å¤„ç†å¤šä¸ªå®ç°çš„æƒ…å†µï¼ˆæ¯”å¦‚é€šè¿‡`@Qualifier`ï¼‰ã€‚

4. **åˆå§‹åŒ–é¡ºåºé—®é¢˜**ï¼š
   - æ²¡æœ‰è€ƒè™‘ä¾èµ–çš„åˆå§‹åŒ–é¡ºåºã€‚
   - ç¼ºå°‘`@PostConstruct`ç­‰ç”Ÿå‘½å‘¨æœŸå›è°ƒæ”¯æŒã€‚

5. **é…ç½®çµæ´»æ€§ä¸è¶³**ï¼š
   - ç¼ºå°‘XML/æ³¨è§£/JavaConfigç­‰å¤šç§é…ç½®æ–¹å¼ã€‚
   - æ²¡æœ‰ç¯å¢ƒé…ç½®(dev/test/prod)æ”¯æŒã€‚

6. **æ€§èƒ½é—®é¢˜**ï¼š
   - æ¯æ¬¡`getBean`éƒ½ä¼šåå°„åˆ›å»ºæ–°å®ä¾‹ï¼ˆåŸå‹ä½œç”¨åŸŸæ—¶ï¼‰ã€‚
   - æ²¡æœ‰ç¼“å­˜åå°„å…ƒæ•°æ®ã€‚

7. **ç±»å‹å®‰å…¨**ï¼š
   - å¤§é‡ä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢(cast)ã€‚
   - æ³›å‹æ”¯æŒä¸å®Œå–„ã€‚

8. **çº¿ç¨‹å®‰å…¨æ€§**ï¼š
   - æ²¡æœ‰è€ƒè™‘å¹¶å‘åœºæ™¯ä¸‹çš„çº¿ç¨‹å®‰å…¨ã€‚
   - singletonInstancesç­‰é›†åˆä¸æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚

9. **å¼‚å¸¸å¤„ç†**ï¼š
   - å¼‚å¸¸ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ã€‚
   - ç¼ºå°‘ç‰¹å®šçš„å¼‚å¸¸ç±»å‹ã€‚

10. **æ‰©å±•æ€§**ï¼š
    - æ²¡æœ‰æä¾›æ‰©å±•ç‚¹(å¦‚`BeanPostProcessor`)ã€‚
    - ä¸æ”¯æŒAOPç­‰é«˜çº§åŠŸèƒ½ã€‚

11. **èµ„æºç®¡ç†**ï¼š
    - æ²¡æœ‰æä¾›é”€æ¯é’©å­æˆ–èµ„æºæ¸…ç†æœºåˆ¶ã€‚
    - å¯¹äºéœ€è¦closeçš„èµ„æºæ²¡æœ‰ç‰¹æ®Šå¤„ç†ã€‚

12. **æµ‹è¯•æ”¯æŒ**ï¼š
    - ç¼ºå°‘mockæ³¨å…¥ç­‰æµ‹è¯•æ”¯æŒåŠŸèƒ½ã€‚

13. **å…¶ä»–åŠŸèƒ½ç¼ºå¤±**ï¼š
    - ä¸æ”¯æŒæ¡ä»¶åŒ–Bean(`@Conditional`)ã€‚
    - ä¸æ”¯æŒprofileã€‚
    - ä¸æ”¯æŒæ‡’åŠ è½½(`@Lazy`)ã€‚
    - ä¸æ”¯æŒ`@Value`ç­‰å±æ€§æ³¨å…¥ã€‚

#### è§£å†³æ–¹æ¡ˆï¼š
1ï¼‰æ”¯æŒå¤šåŒ…æ‰«æï¼Œå¹¶å†™å…¥é…ç½®æ–‡ä»¶  
è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸è®°å½•äº†ã€‚

2ï¼‰é¢„å¤„ç†ä¾èµ–
```java
// æ„å»ºä¾èµ–å›¾ æŸ¥è¯¢è§£æä¾èµ–çš„Beanåç§°ï¼ŒæŸ¥è¯¢å…¶è¢«@KatAutowiredæ ‡è®°çš„å­æ®µ,
// ç„¶åé€šè¿‡æ‹“æ‰‘æ’åºé‡æ’ä¾èµ–å¤„ç†é¡ºåº
private void buildDependencyGraph() {
    // åˆå§‹åŒ–å›¾å’Œå…¥åº¦
    registry.getClassRegistry().keySet().forEach(beanName -> {
        dependencyGraph.put(beanName, new ArrayList<>());
        inDegree.put(beanName, 0);
    });

    // æ„å»ºä¾èµ–å…³ç³»
    registry.getClassRegistry().forEach((beanName, clazz) -> {
        // å¤„ç†å­—æ®µä¾èµ–
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(KatAutowired.class)) {
                String dependencyName = registry.resolveBeanName(field.getType());
                dependencyGraph.get(beanName).add(dependencyName);
                inDegree.put(dependencyName, inDegree.get(dependencyName) + 1);
            }
        }

        // å¤„ç†æ„é€ å™¨ä¾èµ–
        Constructor<?> autowiredCtor = findAutowiredConstructor(clazz);
        if (autowiredCtor != null) {
            for (Class<?> paramType : autowiredCtor.getParameterTypes()) {
                String dependencyName = registry.resolveBeanName(paramType);
                dependencyGraph.get(beanName).add(dependencyName);
                inDegree.put(dependencyName, inDegree.get(dependencyName) + 1);
            }
        }
    });
}
```

3ï¼‰AOPæ”¯æŒ  
å…³äºè¿™ä¸€å¤§å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œç§»æ­¥åˆ°ä¸€ä¸ªå¤§åˆ†æ”¯è¿›è¡Œåˆ†æã€‚

4ï¼‰å¹¶å‘å®‰å…¨  
**éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTomcatæœåŠ¡å™¨æ˜¯å®ç°äº†å¤šçº¿ç¨‹çš„**  
é€šè¿‡`synchronized`äº’æ–¥é”å’Œ`ConcurrentHashMap`ï¼ˆå†…éƒ¨å®ç°äº†`synchronized`ï¼‰  
åœ¨mapæ’å…¥æ—¶ä½¿ç”¨`putIfAbsent`è€Œä¸æ˜¯`put`ï¼Œå› ä¸º`putIfAbsent`æ˜¯åŸå­æ“ä½œï¼Œæ›´é€‚åˆå¹¶å‘ç¯å¢ƒã€‚

### 2. ç±»åŠ è½½å™¨éš”ç¦»é—®é¢˜
Javaç±»åŠ è½½å™¨æ˜¯Javaè¿è¡Œæ—¶ç¯å¢ƒ(JRE)çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè´Ÿè´£åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½Javaç±»åˆ°JVMå†…å­˜ä¸­ã€‚å¯ä»¥é€šè¿‡ç»§æ‰¿`java.lang.ClassLoader`ç±»å¹¶é‡å†™`findClass()`æ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨(è¿™é‡Œä¸å±•å¼€è®²)ã€‚

**ç±»åŠ è½½å™¨çš„éš”ç¦»åŸç†**ï¼š  
æ¯ä¸ªç±»åŠ è½½å™¨å®ä¾‹éƒ½æœ‰ç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œ**åŒä¸€ä¸ªç±»è¢«ä¸åŒç±»åŠ è½½å™¨åŠ è½½ä¼šè¢«JVMè§†ä¸ºä¸åŒçš„ç±»**ã€‚  

Tomcatç­‰Webå®¹å™¨ä¸ºæ¯ä¸ªWebåº”ç”¨åˆ›å»ºç‹¬ç«‹çš„`WebAppClassLoader`ï¼š
```
Common ClassLoader
  â”œâ”€â”€ WebApp1 ClassLoader
  â””â”€â”€ WebApp2 ClassLoader
```
è¿™ä¹Ÿæ˜¯Tomcatçƒ­éƒ¨ç½²çš„å·¥ä½œåŸç†ï¼šåˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨åŠ è½½ä¿®æ”¹åçš„ç±»ã€‚

åœ¨æˆ‘æ„å»ºçš„DIå®¹å™¨ä¸­ï¼Œç±»è·¯å¾„æ‰«æå™¨ä½¿ç”¨çš„æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆ`AppClassLoader`ï¼‰ï¼Œè€ŒTomcatå®ç°äº†è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå¯¼è‡´äº†ç±»åŠ è½½éš”ç¦»ã€‚

**é—®é¢˜æè¿°**ï¼š  
å› ä¸ºTomcatæ²¡æœ‰è¢«Beanå®¹å™¨ç®¡ç†ï¼Œå¹¶ä¸”`@WebServlet("/*")`ä½¿å¾—Tomcatå¯¹ç±»æœ‰è‡ªå·±çš„å®ç°ï¼Œä¸`@KatComponent`äº§ç”Ÿäº†å†²çªã€‚å› æ­¤éœ€è¦åœ¨controllerå±‚é‡å†™`init`æ–¹æ³•ï¼Œæ‰‹åŠ¨æ³¨å…¥ä¾èµ–ï¼š
```java
public void init() throws ServletException {
    super.init();
    // ä» ServletContext è·å– ContainerFactory
    ContainerFactory factory = (ContainerFactory) getServletContext().getAttribute("ContainerFactory");
    if (factory == null) {
        throw new ServletException("ContainerFactory æœªåˆå§‹åŒ–ï¼");
    }
    try {
        factory.injectDependencies(this); // æ‰‹åŠ¨æ³¨å…¥ä¾èµ–
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```
å¦‚æœä¸æ›´æ”¹ç±»åŠ è½½å™¨ï¼Œ`factory.injectDependencies(this)`è¿™ä¸€æ­¥å°†ä¼šæ³¨å…¥å¤±è´¥ï¼Œå› ä¸ºcontrollerå±‚çš„`movieService`æ˜¯ç”±Tomcatç±»åŠ è½½å™¨å®ä¾‹åŒ–çš„ï¼Œè€Œ`movieServiceImpl`åˆ™æ˜¯`Class.forName(className, false, Thread.currentThread().getContextClassLoader())`æ—¶ç”±å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åŠ è½½å™¨å†³å®šçš„ã€‚

**è§£å†³æ–¹æ³•**ï¼š  
åœ¨å¯åŠ¨æœåŠ¡å™¨å
```java
tomcat.start();
// è·å–Tomcatç±»åŠ è½½å™¨
ClassLoader tomcatLoader = ctx.getLoader().getClassLoader();
// è®¾ç½®ç±»åŠ è½½å™¨
Thread.currentThread().setContextClassLoader(tomcatLoader);
ClassPathScanner.setClassLoader(tomcatLoader);
```
è¿™é‡Œçš„å…³é”®æ˜¯`Thread.currentThread().setContextClassLoader(tomcatLoader)`ã€‚ä¸ºä»€ä¹ˆï¼Ÿ  
åœ¨Javaçš„ç±»åŠ è½½æœºåˆ¶ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç±»çš„åŠ è½½éµå¾ª*åŒäº²å§”æ´¾æ¨¡å‹*ï¼š  
ç±»åŠ è½½å™¨ä¼šå…ˆå§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨æ‰¾ä¸åˆ°ï¼Œæ‰è‡ªå·±åŠ è½½ã€‚è€ŒTomcatçš„`WebAppClassLoader`æ˜¯`AppClassLoader`çš„å­åŠ è½½å™¨ã€‚  
```
Bootstrap ClassLoader (JVMå†…ç½®)
  â†“
Extension ClassLoader (JVMå†…ç½®)
  â†“
System/App ClassLoader (JVMå†…ç½®ï¼ŒåŠ è½½CLASSPATH)
  â†“
Common ClassLoader (Tomcat)
  â”œâ”€â”€ Catalina ClassLoader (Tomcatå®¹å™¨ä¸“ç”¨)
  â”œâ”€â”€ Shared ClassLoader (Webåº”ç”¨å…±äº«)
  â””â”€â”€ WebApp ClassLoader (æ¯ä¸ªWebåº”ç”¨ç‹¬ç«‹)
```
é€šè¿‡è®¾ç½®ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œ`DriverManager`ä½¿ç”¨å½“å‰çº¿ç¨‹çš„`ContextClassLoader`ï¼ˆå³`WebAppClassLoader`ï¼‰æ¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„é™åˆ¶ï¼Œè®©çˆ¶åŠ è½½å™¨ï¼ˆ`AppClassLoader`ï¼‰èƒ½è®¿é—®å­åŠ è½½å™¨ï¼ˆ`WebAppClassLoader`ï¼‰åŠ è½½çš„ç±»ã€‚

### 3. å…³äºgitæäº¤çš„ä¸€äº›è§„èŒƒ
**åŸºæœ¬æ ¼å¼**  
`<type>(<scope>): <subject>`  
`Footer`

**å¸¸ç”¨type**ï¼š  
- `feat`ï¼šæ–°åŠŸèƒ½ï¼ˆfeatureï¼‰çš„æ·»åŠ ã€‚
- `fix`ï¼šä¿®å¤bugæˆ–é—®é¢˜ã€‚
- `docs`ï¼šä»…æ–‡æ¡£å†…å®¹çš„æ›´æ”¹ï¼ˆå¦‚ READMEã€æ³¨é‡Šï¼‰ã€‚
- `style`ï¼šä»£ç æ ¼å¼çš„æ›´æ”¹ï¼ˆä¸å½±å“ä»£ç è¿è¡Œçš„å˜åŠ¨ï¼Œä¾‹å¦‚ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€ç­‰å·ç­‰ï¼‰ã€‚
- `refactor`ï¼šä»£ç é‡æ„ï¼ˆæ—¢ä¸æ·»åŠ æ–°åŠŸèƒ½ä¹Ÿä¸ä¿®å¤bugçš„ä»£ç å˜åŠ¨ï¼‰ã€‚
- `test`ï¼šæ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•ï¼ˆåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ç­‰ï¼‰ã€‚
- `chore`ï¼šæ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨ï¼ˆä¾‹å¦‚æ›´æ–°ä¾èµ–ã€ä¿®æ”¹æ„å»ºè„šæœ¬ç­‰ï¼‰ã€‚`gitignore`ç”¨è¿™ä¸ªã€‚
- `build`ï¼šå½±å“é¡¹ç›®æ„å»ºæˆ–å¤–éƒ¨ä¾èµ–é¡¹çš„æ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°äº†`package.json`ã€`pom.xml`æˆ–`build.gradle`æ–‡ä»¶ï¼‰ã€‚
- `ci`ï¼šæŒç»­é›†æˆé…ç½®æ–‡ä»¶å’Œè„šæœ¬çš„æ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°`.travis.yml`ã€`.gitlab-ci.yml`ç­‰ï¼‰ã€‚é…ç½®æ–‡ä»¶æ›´æ”¹ç”¨è¿™ä¸ªã€‚
- `perf`ï¼šæ€§èƒ½ä¼˜åŒ–ã€‚
- `revert`ï¼šæ’¤é”€ä¹‹å‰çš„æäº¤ã€‚
- `merge`ï¼šåˆå¹¶åˆ†æ”¯ï¼ˆé€šå¸¸ç”±Gitè‡ªåŠ¨ç”Ÿæˆï¼‰ã€‚
- `init`ï¼šé¡¹ç›®çš„åˆå§‹åŒ–æäº¤ã€‚

**scope**ï¼š  
å¯ä»¥æ˜¯é¡¹ç›®ä¸­ä»»ä½•å¯è¯†åˆ«çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚æ–‡ä»¶åã€æ¨¡å—åã€åŠŸèƒ½åŒºåŸŸç­‰ã€‚  
**å½±å“èŒƒå›´æ¯”è¾ƒå¤§æ—¶ç”¨æ¨¡å—åï¼Œæ¯”è¾ƒå°æ—¶ç”¨ç±»/å½±å“**  
ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å½±å“`scope`å€¼ç¤ºä¾‹ï¼š
- `ui`ï¼šç”¨æˆ·ç•Œé¢ç›¸å…³çš„æ›´æ”¹ã€‚
- `api`ï¼šAPIæ¥å£æˆ–åç«¯æœåŠ¡çš„æ›´æ”¹ã€‚
- `db`ï¼šæ•°æ®åº“ç›¸å…³çš„æ›´æ”¹ï¼Œå¦‚æ¨¡å¼ã€è¿ç§»ç­‰ã€‚
- `auth`ï¼šè®¤è¯å’Œæˆæƒç›¸å…³çš„æ›´æ”¹ã€‚
- `config`ï¼šé…ç½®æ–‡ä»¶æˆ–è®¾ç½®çš„æ›´æ”¹ã€‚
- `deps`æˆ–`dependencies`ï¼šä¾èµ–é¡¹çš„æ›´æ–°æˆ–æ›´æ”¹ã€‚
- `tests`ï¼šæµ‹è¯•ä»£ç çš„æ›´æ”¹ã€‚
- `cli`ï¼šå‘½ä»¤è¡Œç•Œé¢ç›¸å…³çš„æ›´æ”¹ã€‚
- `docs`ï¼šæ–‡æ¡£å†…å®¹çš„æ›´æ”¹ã€‚
- `build`ï¼šæ„å»ºç³»ç»Ÿæˆ–è„šæœ¬çš„æ›´æ”¹ã€‚
- `ci`ï¼šæŒç»­é›†æˆé…ç½®çš„æ›´æ”¹ã€‚
- `perf`ï¼šæ€§èƒ½ä¼˜åŒ–ç›¸å…³çš„æ›´æ”¹ã€‚
- `security`ï¼šå®‰å…¨æ€§ç›¸å…³çš„æ›´æ”¹ã€‚
- `logging`ï¼šæ—¥å¿—ç³»ç»Ÿçš„æ›´æ”¹ã€‚
- `internationalization`æˆ–`i18n`ï¼šå›½é™…åŒ–å’Œæœ¬åœ°åŒ–çš„æ›´æ”¹ã€‚
- `migration`ï¼šæ•°æ®è¿ç§»æˆ–ç³»ç»Ÿè¿ç§»ç›¸å…³çš„æ›´æ”¹ã€‚
- `cleanup`ï¼šä»£ç æ¸…ç†ï¼Œå¦‚åˆ é™¤æ— ç”¨ä»£ç æˆ–é‡æ„ã€‚
- `refactor`ï¼šä»£ç é‡æ„ï¼Œä¸æ”¹å˜å¤–éƒ¨è¡Œä¸ºçš„å†…éƒ¨ç»“æ„è°ƒæ•´ã€‚
- `feature`ï¼šç‰¹å®šåŠŸèƒ½æ¨¡å—çš„æ›´æ”¹ã€‚
- `bugfix`ï¼šç‰¹å®šbugä¿®å¤çš„æ›´æ”¹ã€‚

**Footer**ï¼š  
- å…³è” Issueï¼šå¦‚`Closes #123`æˆ–`Fixes #456`ã€‚
- ç ´åæ€§å˜æ›´ï¼šä»¥`BREAKING CHANGE:`å¼€å¤´ï¼Œæè¿°ä¸å…¼å®¹çš„æ”¹åŠ¨ã€‚  
é€šå¸¸åœ¨é•¿æœŸç»´æŠ¤çš„é¡¹ç›®ä¸­ä½¿ç”¨ã€‚

### 4. æ‰‹æ“AOPå¤„ç†å™¨
å…ˆæ¥çœ‹çœ‹AOPçš„å·¥ä½œæµç¨‹ï¼š  
1. æ‰«ææ³¨è§£  
2. æ³¨å†Œåˆ‡é¢ç±»/æ–¹æ³•  
3. è§£æï¼ŒåŒ¹é…åˆ‡é¢è¡¨è¾¾å¼  
4. åŠ¨æ€ä»£ç†å®ç°ç±»  

#### 1ï¼‰æ‰«ææ³¨è§£  
è¿™é‡Œå¯ä»¥é›†æˆåˆ°æˆ‘çš„DIå®¹å™¨æ³¨å†Œä¸­ã€‚  
å®šä¹‰åˆ‡é¢ç±»æ˜ å°„ï¼š
```java
private final Set<Class<?>> aspectClasses = new HashSet<>();
```
é€šè¿‡è·¯å¾„æ‰«æåˆ‡é¢(ä¸`Component`çš„æ‰«æç±»ä¼¼)ï¼š
```java
private void scanAspects() {
    List<Class<?>> aspectList = basePackages.stream()
            .flatMap(pkg -> ClassPathScanner.scanClassesWithAnnotation(pkg, KatAspect.class).stream())
            .toList();

    aspectList.forEach(aspect -> {
        aspectClasses.add(aspect);
        registerClass(aspect);  // åˆ‡é¢ä¹Ÿéœ€è¦ä½œä¸ºæ™®é€šBeanæ³¨å†Œ
    });
}
```

#### 2ï¼‰æ³¨å†Œåˆ‡é¢ç±»/æ–¹æ³•  
åœ¨`BeanBuilder`ä¸­ï¼Œæ‰§è¡Œä¾èµ–å›¾å¤„ç†åå¯¹AOPè¿›è¡Œæ³¨å†Œï¼š
```java
// å¤„ç†aopæ³¨å†Œ
private void processAspects() {
    registry.getAspectClasses().forEach(aspectClass -> {
        try {
            Object aspect = createAspectInstance(aspectClass);
            aspectInstances.put(aspectClass, aspect);
            aspectProcessor.registerAspect(aspect);
        } catch (Exception e) {
            throw new RuntimeException("Aspect initialization failed: " + aspectClass.getName(), e);
        }
    });
}
```
åˆ‡é¢ä¹Ÿéœ€è¦ä¾èµ–æ³¨å…¥ï¼š
```java
private Object createAspectInstance(Class<?> aspectClass) throws Exception {
    Object instance = createRawInstance(aspectClass);
    injectFields(instance);
    return instance;
}
```
åœ¨è°ƒç”¨`aspectProcessor.registerAspect(aspect)`æ–¹æ³•æ—¶ï¼Œå°†åˆ‡é¢å®ä¾‹è¿”å›ç»™`AspectProcessor`ç±»ï¼Œæ³¨å†Œåˆ°åˆ‡é¢æ˜ å°„ä¸­ï¼š
```java
// ç¼“å­˜åˆ‡ç‚¹è¡¨è¾¾å¼ä¸å¯¹åº”é€šçŸ¥æ–¹æ³•çš„æ˜ å°„
private final Map<String, List<AdviceWrapper>> aspectCache = new ConcurrentHashMap<>();
// æ³¨å†Œåˆ‡é¢ç±»
public void registerAspect(Object aspect) {
    Class<?> aspectClass = aspect.getClass();
    Arrays.stream(aspectClass.getMethods())
            .filter(m -> m.isAnnotationPresent(KatAround.class))
            .forEach(method -> registerAdvice(aspect, method));
}
// æ³¨å†Œå•ä¸ªé€šçŸ¥æ–¹æ³•
private void registerAdvice(Object aspect, Method adviceMethod) {
    KatAround around = adviceMethod.getAnnotation(KatAround.class);
    String pointcut = around.value();
    int priority = adviceMethod.isAnnotationPresent(KatOrder.class)
            ? adviceMethod.getAnnotation(KatOrder.class).value() : 0;

    // ç¼–è¯‘åˆ‡ç‚¹è¡¨è¾¾å¼
    compiledPatterns.computeIfAbsent(pointcut, this::compilePointcut);

    // æ³¨å†Œé€šçŸ¥æ–¹æ³•å¹¶æŒ‰ä¼˜å…ˆçº§æ’åº
    aspectCache.computeIfAbsent(pointcut, k -> new CopyOnWriteArrayList<>())
            .add(new AdviceWrapper(aspect, adviceMethod, priority));

    aspectCache.get(pointcut).sort(Comparator.comparingInt(AdviceWrapper::priority));
}
```
`AdviceWrapper`æ˜¯ä¸€ä¸ªé€šçŸ¥åŒ…è£…ç±»ï¼ŒåŒ…å«äº†åˆ‡é¢å®ä¾‹ï¼Œé€šçŸ¥æ–¹æ³•ï¼Œä¼˜å…ˆçº§ç­‰ä¿¡æ¯ï¼š
```java
// é€šçŸ¥åŒ…è£…ç±»
private record AdviceWrapper(Object aspectInstance, Method adviceMethod, int priority) {
    private AdviceWrapper(Object aspectInstance, Method adviceMethod, int priority) {
        this.aspectInstance = aspectInstance;
        this.adviceMethod = adviceMethod;
        this.priority = priority;
        this.adviceMethod.setAccessible(true);
    }

    public Object invoke(ProceedingJoinPoint joinPoint) throws Throwable {
        return adviceMethod.invoke(aspectInstance, joinPoint);
    }
}
```
å…³äºåˆ‡é¢è¡¨è¾¾å¼éƒ¨åˆ†ï¼Œåˆ™æ˜¯å®ç°äº†è¾ƒä¸ºå¤æ‚çš„é€å­—ç¬¦åŒ¹é…ï¼Œæ¥é¿å…ç›´æ¥æ›¿æ¢å¯¼è‡´çš„é—®é¢˜ï¼š
```java
// ç¼–è¯‘åˆ‡ç‚¹è¡¨è¾¾å¼ä¸ºæ­£åˆ™
private Pattern compilePointcut(String expression) {
    String regex = convertToRegex(expression);
    return Pattern.compile(regex);
}

// è½¬æ¢åˆ‡ç‚¹è¡¨è¾¾å¼ä¸ºæ­£åˆ™
private static String convertToRegex(String pointcut) {
    // å…ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ï¼ˆä½†ä¸å¤„ç†é€šé…ç¬¦ï¼‰
    StringBuilder regex = new StringBuilder();
    char[] chars = pointcut.toCharArray();

    for (int i = 0; i < chars.length; i++) {
        char c = chars[i];

        // å¤„ç†..é€šé…ç¬¦ï¼ˆéœ€è¦çœ‹åç»­å­—ç¬¦ï¼‰
        if (c == '.' && i + 1 < chars.length && chars[i + 1] == '.') {
            regex.append("\\..+?"); // éè´ªå©ªåŒ¹é…
            i++; // è·³è¿‡ä¸‹ä¸€ä¸ªç‚¹
            continue;
        }

        // å¤„ç†æ™®é€šå­—ç¬¦è½¬ä¹‰
        switch (c) {
            case '.':
                regex.append("\\.");
                break;
            case '$':
                regex.append("\\$");
                break;
            case '*':
                // ä¸´æ—¶æ ‡è®°ï¼Œåé¢ç»Ÿä¸€å¤„ç†
                regex.append("\u0001");
                break;
            case '(':
                // å‚æ•°éƒ¨åˆ†ä¸´æ—¶æ ‡è®°
                regex.append(handleParameters(chars, i));
                i = skipParameters(chars, i);
                break;
            default:
                regex.append(c);
        }
    }

    // æœ€åå¤„ç†*é€šé…ç¬¦ï¼ˆé¿å…è¢«å‰é¢æ›¿æ¢å½±å“ï¼‰
    String result = regex.toString().replace("\u0001", "[^.]+");
    return "^" + result + "$";
}

// å¤„ç†å‚æ•°éƒ¨åˆ†
private static String handleParameters(char[] chars, int start) {
    int end = findParameterEnd(chars, start);
    String params = new String(chars, start, end - start + 1);

    return switch (params) {
        case "(..)" -> "\\(.*\\)";
        case "()" -> "\\(\\)";
        case "(*)" -> "\\([^,]+\\)";
        default -> Pattern.quote(params); // å…¶ä»–å‚æ•°å½¢å¼åŸæ ·åŒ¹é…
    };
}
```
`skipParameters`å’Œ`findParameterEnd`ç”¨äºå¤„ç†åµŒå¥—æ‹¬å·ã€‚

**è½¬æ¢è§„åˆ™**ï¼š  
| åˆ‡ç‚¹è¯­æ³•       | æ­£åˆ™è¡¨è¾¾å¼      | è¯´æ˜                          |
|----------------|-----------------|-----------------------------|
| `.`            | `\\.`           | è½¬ä¹‰åŒ…åˆ†éš”ç¬¦                   |
| `..`           | `\\..+?`        | åŒ¹é…ä»»æ„å­åŒ…ï¼ˆéè´ªå©ªï¼‰          |
| `*`            | `[^.]+`         | åŒ¹é…éç‚¹å­—ç¬¦ï¼ˆä¸è·¨è¶ŠåŒ…å±‚çº§ï¼‰     |
| `(..)`         | `\\(.*\\)`      | åŒ¹é…ä»»æ„å‚æ•°                   |
| `()`           | `\\(\\)`        | åŒ¹é…æ— å‚æ•°æ–¹æ³•                 |
| `(*)`          | `\\([^,]+\\)`   | åŒ¹é…å•ä¸ªä»»æ„ç±»å‹å‚æ•°            |
| å…¶ä»–å‚æ•°å½¢å¼     | åŸæ ·ä¿ç•™         | å¦‚ `(String,int)`            |

**ç¤ºä¾‹è½¬æ¢è¿‡ç¨‹**ï¼š  
è¾“å…¥åˆ‡ç‚¹ï¼š  
`com.example..service.*.*(..)`  

è½¬æ¢æ­¥éª¤ï¼š  
- `..` â†’ `\\..+?`  
- `.` â†’ `\\.`  
- `*` â†’ `\u0001`ï¼ˆä¸´æ—¶ï¼‰  
- `(..)` â†’ `\\(.*\\)`  
- æ›¿æ¢ `\u0001` â†’ `[^.]+`  
- æ·»åŠ è¾¹ç•Œç¬¦  

æœ€ç»ˆæ­£åˆ™ï¼š  
`^com\.example\..+?service\.[^.]+\.[^.]+\(.*\)$`  

#### 3ï¼‰è§£æï¼ŒåŒ¹é…åˆ‡é¢è¡¨è¾¾å¼  
åœ¨`BeanBuilder`æ–¹æ³•ä¸­ï¼Œåœ¨åˆ›å»ºå®ä¾‹è¿™ä¸€æ­¥åŠ å…¥å¯¹AOPä»£ç†çš„åˆ¤æ–­ï¼š
```java
// åˆ›å»ºå®ä¾‹
private Object createInstance(Class<?> clazz) throws Exception {
    // 1. åˆ›å»ºåŸå§‹å®ä¾‹ï¼ˆä¸åŒºåˆ†å•ä¾‹/åŸå‹ï¼‰
    Object rawInstance;
    Constructor<?> autowiredCtor = findAutowiredConstructor(clazz);
    if (autowiredCtor != null) {
        rawInstance = createInstanceWithConstructor(autowiredCtor);
    } else {
        rawInstance = clazz.getDeclaredConstructor().newInstance();
    }

    // 2. æ³¨å…¥ä¾èµ–
    injectFields(rawInstance);

    // 3. ç»Ÿä¸€åº”ç”¨AOPä»£ç†ï¼ˆæ— è®ºæ˜¯å¦å•ä¾‹ï¼‰
    return wrapWithAopIfNeeded(rawInstance, clazz);
}
// åˆ¤æ–­æ˜¯å¦è¦ç”Ÿæˆä»£ç†
private Object wrapWithAopIfNeeded(Object rawInstance, Class<?> targetClass) {
    try {
        if (shouldProxy(targetClass)) {
            return createProxy(rawInstance, targetClass);
        }
        return rawInstance;
    } catch (Exception e) {
        throw new RuntimeException("AOP proxy creation failed for " + targetClass.getName(), e);
    }
}
private boolean shouldProxy(Class<?> targetClass) {
    // ä¸æ˜¯åˆ‡é¢ç±» && æœ‰åŒ¹é…çš„åˆ‡é¢é€»è¾‘
    return !targetClass.isAnnotationPresent(KatAspect.class) &&
            aspectProcessor.hasMatchingAdvice(targetClass);
}
```
è½¬äº¤ç»™`Aspectprocessor`ç±»æ£€æŸ¥åˆ‡é¢åŒ¹é…ï¼š
```java
// æ£€æŸ¥ç±»æ˜¯å¦æœ‰åŒ¹é…çš„åˆ‡é¢
public boolean hasMatchingAdvice(Class<?> targetClass) {
    return aspectCache.keySet().stream()
            .anyMatch(pointcut -> {
                // æ„å»ºç±»åæ¨¡å¼ï¼šcom.example.Service -> com.example.Service.*(..)
                String classPattern = targetClass.getName() + ".*(..)";
                return matchesPointcut(pointcut, classPattern);
            });
}

// æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰åŒ¹é…çš„åˆ‡é¢
public boolean hasMatchingAdvice(Method method) {
    String methodSignature = buildMethodSignature(method);
    return aspectCache.keySet().stream()
            .anyMatch(pointcut -> matchesPointcut(pointcut, methodSignature));
}

// æ£€æŸ¥åˆ‡ç‚¹æ˜¯å¦åŒ¹é…ç­¾å
private boolean matchesPointcut(String pointcut, String signature) {
    Pattern pattern = compiledPatterns.get(pointcut);
    if (pattern == null) {
        pattern = compilePointcut(pointcut);
        compiledPatterns.put(pointcut, pattern);
    }
    return pattern.matcher(signature).matches();
}
```
åˆ‡é¢å¤„ç†æˆæ­£åˆ™çš„å¤„ç†é€»è¾‘å·²ç»åœ¨ä¸Šé¢ç»™å‡ºã€‚

#### 4ï¼‰åŠ¨æ€ä»£ç†å®ç°ç±»  
å¦‚æœæ‰¾åˆ°åŒ¹é…çš„åˆ‡é¢åˆ™è¿”å›`BeanBuilder`ç±»ä¸­è¿›è¡Œä»£ç†å¯¹è±¡çš„åˆ›å»ºï¼š
```java
private Object createProxy(Object target, Class<?> targetClass) throws Exception {
    if (targetClass.isInterface()) { //JDKçš„ä»£ç†åªèƒ½å¤„ç†æ¥å£å¯¹è±¡
        return Proxy.newProxyInstance(
                targetClass.getClassLoader(),
                new Class<?>[]{targetClass},
                (proxy, method, args) -> aspectProcessor.applyAspects(target, method, args) //è°ƒç”¨å§”æ‰˜ç»™AspectProcessor
        );
    } else { 
        return new ByteBuddy()
                .subclass(targetClass) // åˆ›å»ºå­ç±»
                .method(not(isDeclaredBy(Object.class))) // æ’é™¤ObjectåŸç”Ÿæ–¹æ³•
                .intercept(MethodDelegation.to(new AspectInterceptor(target, aspectProcessor))) // å§”æ‰˜ç»™æ‹¦æˆªå™¨
                .make()
                .load(targetClass.getClassLoader(),  ClassLoadingStrategy.Default.INJECTION) // ä½¿ç”¨INJECTIONç­–ç•¥(æ–°ç±»æ³¨å…¥åˆ°ç›®æ ‡ç±»çš„ClassLoaderä¸­)
                .getLoaded()
                .getDeclaredConstructor()
                .newInstance();
    }
}
```

**ByteBuddy**æ˜¯ä¸€ä¸ªå­—èŠ‚ç å¢å¼ºç®¡ç†åº“ï¼š
```xml
<!-- bytebuddy -->
<dependency>
    <groupId>net.bytebuddy</groupId>
    <artifactId>byte-buddy</artifactId>
    <version>1.15.11</version>
</dependency>
<dependency>
    <groupId>net.bytebuddy</groupId>
    <artifactId>byte-buddy-agent</artifactId>
    <version>1.15.11</version>
</dependency>
```

**AspectInterceptor**æ–¹æ³•æ‹¦æˆªå™¨  
é€šè¿‡æ–¹æ³•æ‹¦æˆªå™¨ï¼Œå°†è°ƒç”¨å§”æ‰˜ç»™`AspectProcessor`ï¼š
```java
public class AspectInterceptor {
    private final Object target;
    private final AspectProcessor aspectProcessor;

    public AspectInterceptor(Object target, AspectProcessor aspectProcessor) {
        this.target = target;
        this.aspectProcessor = aspectProcessor;
    }

    //åœ¨è¿è¡Œæ—¶ï¼Œæ‹¦æˆªç›®æ ‡æ–¹æ³•ï¼Œå¹¶æ‰§è¡Œåˆ‡é¢é€»è¾‘
    @RuntimeType
    public Object intercept(@Origin Method method,
                            @AllArguments Object[] args,
                            @SuperCall Callable<?> callable) throws Exception {
        try {
            return aspectProcessor.applyAspects(target, method, args);
        } catch (Throwable throwable) {
            if (throwable instanceof Exception) {
                throw (Exception) throwable;
            }
            throw new Exception(throwable);
        }
    }
}
```

å›åˆ°`AspectInterceptor`ç±»ï¼Œæ‰§è¡Œå§”æ‰˜çš„åˆ‡é¢é€»è¾‘ï¼š
```java
// æ‰§è¡Œåˆ‡é¢é€»è¾‘
public Object applyAspects(Object target, Method method, Object[] args) throws Throwable {
    // æ„å»ºæ›´ç²¾ç¡®çš„æ–¹æ³•ç­¾å
    String methodSignature = target.getClass().getName() + "." + method.getName() +
            "(" + Arrays.stream(method.getParameterTypes())
            .map(Class::getName)
            .collect(Collectors.joining(",")) + ")";

    // æŸ¥æ‰¾åŒ¹é…çš„åˆ‡é¢
    List<AdviceWrapper> matchedAdvices = aspectCache.entrySet().stream()
            .filter(entry -> matchesPointcut(entry.getKey(), methodSignature))
            .flatMap(entry -> entry.getValue().stream())
            .sorted(Comparator.comparingInt(AdviceWrapper::priority))
            .toList();

    if (matchedAdvices.isEmpty()) {
        return method.invoke(target, args);
    }

    // åˆ›å»ºè¿æ¥ç‚¹
    ProceedingJoinPoint joinPoint = new ProceedingJoinPoint(target, method, args);

    // æ‰§è¡Œé€šçŸ¥é“¾
    Object result = null;
    for (AdviceWrapper advice : matchedAdvices) {
        result = advice.invoke(joinPoint);
    }
    return result;
}
```

**é€šçŸ¥é“¾æ‰§è¡Œæµç¨‹**ï¼š  
```mermaid
sequenceDiagram
    participant A as applyAspects
    participant J as ProceedingJoinPoint
    participant W as AdviceWrapper
    participant T as Target
    
    A->>J: åˆ›å»º(ç›®æ ‡,æ–¹æ³•,å‚æ•°)
    loop é€šçŸ¥é“¾
        A->>W: invoke(joinPoint)
        W->>J: æ‰§è¡Œåˆ‡é¢é€»è¾‘
        alt éœ€è¦ç»§ç»­
            J->>T: proceed()
        end
    end
    A->>A: è¿”å›æœ€ç»ˆç»“æœ
```

### **å…¸å‹åœºæ™¯ç¤ºä¾‹**
#### **åœºæ™¯**ï¼šæ‰§è¡Œ `userService.save(user)` æ–¹æ³•
1. **ç­¾åç”Ÿæˆ**  
   â†’ `"com.service.UserService.save(com.entity.User)"`

2. **åˆ‡é¢åŒ¹é…**  
   - åŒ¹é… `@Around("com.service..*.save*(..)")`  
   - åŒ¹é… `@Before("execution(* save(*))")`

3. **æ‰§è¡Œé¡ºåº**  
   ```text
   1. @Before åˆ‡é¢
   2. @Around åˆ‡é¢ï¼ˆå†…éƒ¨è°ƒç”¨ proceed()ï¼‰
   3. å®é™…æ‰§è¡Œ save() æ–¹æ³•
   4. @Around å‰©ä½™é€»è¾‘
   5. @AfterReturning åˆ‡é¢
   ```

**è¿æ¥ç‚¹`joinPoint`**ï¼Œæ˜¯è¿æ¥é€šçŸ¥å’Œä»£ç†å®ä¾‹çš„æ¡¥æ¢ï¼š
```java
public record ProceedingJoinPoint(Object target, Method method, Object[] args) {

    public Object proceed() throws Exception {
        return method.invoke(target, args);
    }
}
```
**æ³¨æ„**ï¼šæ¯ä¸ªåˆ‡é¢éƒ½æ”¶åˆ°åŒä¸€ä¸ª`joinPoint`å¯¹è±¡ï¼Œç”¨äºè®°å½•å½“å‰çš„è¿›ç¨‹çŠ¶æ€ã€‚é€šè¿‡ä»¥ä¸‹çš„ç¤ºä¾‹ï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£é€šçŸ¥é“¾çš„æ‰§è¡Œæµç¨‹ï¼š
```mermaid
sequenceDiagram
    participant Client as è°ƒç”¨è€…
    participant Proxy as ä»£ç†
    participant A1 as åˆ‡é¢1
    participant A2 as åˆ‡é¢2
    participant A3 as åˆ‡é¢3
    participant Target as ç›®æ ‡æ–¹æ³•

    Client->>Proxy: è°ƒç”¨æ–¹æ³•()
    Proxy->>A1: invoke(joinPoint)
    Note right of A1: joinPointçŠ¶æ€:<br>currentPosition=0
    A1->>joinPoint: proceed()
    joinPoint->>A2: invoke(joinPoint)
    Note right of A2: joinPointçŠ¶æ€:<br>currentPosition=1
    A2->>joinPoint: proceed()
    joinPoint->>A3: invoke(joinPoint)
    Note right of A3: joinPointçŠ¶æ€:<br>currentPosition=2
    A3->>joinPoint: proceed()
    joinPoint->>Target: åå°„è°ƒç”¨()
    Target-->>joinPoint: ç»“æœ
    joinPoint-->>A3: è¿”å›
    A3-->>joinPoint: è¿”å›
    joinPoint-->>A2: è¿”å›
    A2-->>joinPoint: è¿”å›
    joinPoint-->>A1: è¿”å›
    A1-->>Proxy: è¿”å›
    Proxy-->>Client: æœ€ç»ˆç»“æœ
```

### 5. é”ä¸å¹¶å‘å®‰å…¨
**åŸºæœ¬çš„çº¿ç¨‹é”**ï¼š  
- **äº’æ–¥é” (synchronized)**  
  æœ€åŸºç¡€çš„å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®å…±äº«èµ„æºã€‚
  ```java
  private final Object lock = new Object();
  public void safeMethod() {
      synchronized(lock) {
          // ä¸´ç•ŒåŒºä»£ç 
      }
  }
  ```

- **è¯»å†™é” (ReadWriteLock)**  
  å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œä¸”å†™æ—¶ä¸èƒ½è¯»ã€‚
  ```java
  ReadWriteLock rwLock = new ReentrantReadWriteLock();
  public void readData() {
      rwLock.readLock().lock();
      try {
          // è¯»å–æ“ä½œ
      } finally {
          rwLock.readLock().unlock();
      }
  }
  public void writeData() {
      rwLock.writeLock().lock();
      try {
          // å†™å…¥æ“ä½œ
      } finally {
          rwLock.writeLock().unlock();
      }
  }
  ```

**åŸºæœ¬çš„å¹¶å‘å®¹å™¨**ï¼š  
- `ConcurrentHashMap`  
- `CopyOnWriteArrayList`  
- `BlockingQueue`  

**é”ç²’åº¦**ï¼š  
æŒ‡é”çš„ä½œç”¨èŒƒå›´å¤§å°ï¼Œåˆç†é€‰æ‹©é”ç²’åº¦èƒ½å¹³è¡¡çº¿ç¨‹å®‰å…¨ä¸ç³»ç»Ÿæ€§èƒ½ã€‚  
- **ç²—ç²’åº¦é”**  
  ```java
  // é”æ•´ä¸ªå¯¹è±¡
  public synchronized void process() {
      // æ‰€æœ‰æ“ä½œéƒ½åœ¨é”å†…
  }

  // é”æ•´ä¸ªé›†åˆ
  synchronized(map) {
      // æ“ä½œmapçš„æ‰€æœ‰æ–¹æ³•
  }
  ```

- **ç»†ç²’åº¦é”**  
  ```java
  // ä¸ºæ¯ä¸ªæ•°æ®é¡¹å•ç‹¬åŠ é”
  public class FineGrainedCache {
      private final Map<Key, Lock> keyLocks = new HashMap<>();
      private final Map<Key, Value> cache = new HashMap<>();
      
      public void update(Key key, Value value) {
          Lock keyLock;
          synchronized(this) {
              keyLock = keyLocks.computeIfAbsent(key, k -> new ReentrantLock());
          }
          keyLock.lock();
          try {
              // åªé”å®šå½“å‰keyçš„æ“ä½œ
              cache.put(key, value);
          } finally {
              keyLock.unlock();
          }
      }
  }
  ```

**åº”å½“ä½¿ç”¨ç»†ç²’åº¦é”çš„åœºæ™¯**ï¼š  
- ä¸´ç•ŒåŒºåŒ…å«I/Oæˆ–è€—æ—¶è®¡ç®—  
- é«˜å¹¶å‘è®¿é—®  
- èµ„æºå¯è‡ªç„¶åˆ†ç‰‡ï¼ˆå¦‚ç”¨æˆ·IDã€è®¢å•IDç­‰ï¼‰  
- éœ€è¦æœ€å¤§åŒ–ååé‡  

**å¸¸è§ä¼˜åŒ–æ¨¡å¼**ï¼š  
1. **é”åˆ†è§£**ï¼šå°†ä¸€ä¸ªå¤§é”æ‹†åˆ†ä¸ºå¤šä¸ªå°é”  
   ```java
   // ä¼˜åŒ–å‰
   public class Account {
       private final Object lock = new Object();
       private long balance;
       private int transactionCount;
       
       public void transfer(Account to, long amount) {
           synchronized(lock) {
               this.balance -= amount;
               to.balance += amount;
               this.transactionCount++;
           }
       }
   }

   // ä¼˜åŒ–å
   public class Account {
       private final Object balanceLock = new Object();
       private final Object countLock = new Object();
       private long balance;
       private int transactionCount;
       
       public void transfer(Account to, long amount) {
           synchronized(balanceLock) {
               this.balance -= amount;
               to.balance += amount;
           }
           synchronized(countLock) {
               this.transactionCount++;
           }
       }
   }
   ```

2. **é”åˆ†æ®µ**ï¼š  
   å•ä¸ªç²—ç²’åº¦é”æ‹†åˆ†ä¸ºå¤šä¸ªç»†ç²’åº¦é”ï¼Œé€šè¿‡å“ˆå¸Œç®—æ³•å°†æ•°æ®æ˜ å°„åˆ°å¯¹åº”çš„é”ã€‚åªæœ‰æ“ä½œåŒä¸€åˆ†æ®µçš„çº¿ç¨‹æ‰ä¼šç«äº‰åŒä¸€æŠŠé”ã€‚  
   ```java
   public class StripedDictionary<K, V> {
       private final int NUM_LOCKS = 16; // åˆ†æ®µæ•°
       private final Map<K, V> map = new HashMap<>();
       private final Object[] locks = new Object[NUM_LOCKS]; // é”æ•°ç»„

       public StripedDictionary() {
           for (int i = 0; i < NUM_LOCKS; i++) {
               locks[i] = new Object(); // åˆå§‹åŒ–æ‰€æœ‰é”
           }
       }

       // é€šè¿‡keyçš„å“ˆå¸Œå†³å®šä½¿ç”¨å“ªä¸ªé”åˆ†æ®µ
       private int getLockIndex(K key) {
           return Math.abs(key.hashCode() % NUM_LOCKS);
       }

       public void put(K key, V value) {
           int lockIndex = getLockIndex(key);
           synchronized (locks[lockIndex]) { // åªé”å®šå½“å‰åˆ†æ®µ
               map.put(key, value);
           }
       }

       public V get(K key) {
           int lockIndex = getLockIndex(key);
           synchronized (locks[lockIndex]) { // åªé”å®šå½“å‰åˆ†æ®µ
               return map.get(key);
           }
       }
   }
   ```

3. **è¯»å†™é”åˆ†ç¦»**ï¼Œä¾‹å¦‚`ReadWriteLock`çš„è®¾è®¡æ¨¡å¼ã€‚

**æ³¨æ„**ï¼šç²’åº¦è¶Šç»†çš„é”ï¼Œè¶Šå®¹æ˜“é¢ä¸´å¤æ‚ç¼–ç¨‹ä¸‹çš„æ­»é”é£é™©ã€‚

**ç®€å•åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ é”**ï¼š  
```mermaid
graph TD
    A[ä»£ç æ®µæ˜¯å¦æ¶‰åŠå…±äº«æ•°æ®?] -->|å¦| B[æ— éœ€åŠ é”]
    A -->|æ˜¯| C{æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹?}
    C -->|åªè¯»| D[æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸å¯å˜]
    D -->|ä¸å¯å˜| B
    D -->|å¯å˜| E[éœ€åŠ é”ä¿è¯å¯è§æ€§]
    C -->|ä¼šä¿®æ”¹| F[éœ€åŠ é”ä¿è¯åŸå­æ€§]
    F --> G{æ˜¯å¦å¤åˆæ“ä½œ?}
    G -->|æ˜¯| H[é”ä½æ•´ä¸ªæ“ä½œåºåˆ—]
    G -->|å¦| I[é€‰æ‹©æœ€å°ç²’åº¦é”]
```

**é¿å…æ­»é”é£é™©çš„æŠ€å·§**ï¼š  
- **é”é¡ºåºå›ºå®šåŒ–**  
  ```mermaid
  flowchart TD
      B0[è½¬è´¦ç¤ºä¾‹] --> B1[æ¯”è¾ƒè´¦æˆ·Aå’ŒBçš„ID]
      B1 -->|A.id < B.id| B2[å…ˆé”Aå†é”B]
      B1 -->|A.id > B.id| B3[å…ˆé”Bå†é”A]
      B2 & B3 --> B4[æ‰§è¡Œè½¬è´¦]
  ```

- **å°è¯•é”æœºåˆ¶**ï¼šå°è¯•è·å–é”ï¼Œè‹¥å¤±è´¥ç«‹å³è¿”å›ï¼Œè€Œä¸ä¼šåƒ`synchronized`ç­‰ä¼ ç»Ÿé”ä¸€æ ·é˜»å¡ç›´åˆ°æˆåŠŸã€‚  
  ```mermaid
  sequenceDiagram
      participant T as çº¿ç¨‹
      participant L1 as é”A
      participant L2 as é”B
      
      T->>L1: tryLock()
      alt é”Aè·å–æˆåŠŸ
          T->>L2: tryLock(å‰©ä½™è¶…æ—¶)
          alt é”Bè·å–æˆåŠŸ
              T->>T: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
              T->>L2: unlock()
          else é”Bè·å–å¤±è´¥
              T->>L1: unlock()
          end
      else é”Aè·å–å¤±è´¥
          T->>T: ç­‰å¾…åé‡è¯•
      end
  ```

- **è¶…æ—¶é‡Šæ”¾**  
  ```mermaid
  stateDiagram-v2
      [*] --> è·å–é”A
      è·å–é”A --> è·å–é”B: å¸¦è¶…æ—¶(500ms)
      
      è·å–é”B --> ä¸šåŠ¡æ“ä½œ: æˆåŠŸ
      è·å–é”B --> é‡Šæ”¾é”A: è¶…æ—¶
      é‡Šæ”¾é”A --> [*]
  ```

- **æ­»é”æ£€æµ‹**  
  ```mermaid
  graph LR
      E1[æ£€æµ‹çº¿ç¨‹] --> E2[æ‰«ææ‰€æœ‰çº¿ç¨‹]
      E2 --> E3[æ„å»ºç­‰å¾…å›¾]
      E3 --> E4{å‘ç°ç¯è·¯?}
      E4 -->|æ˜¯| E5[ä¸­æ–­æ­»é”çº¿ç¨‹]
      E4 -->|å¦| E6[ç»§ç»­ç›‘æ§]
  ```

**æ³¨æ„**ï¼šå®é™…å¼€å‘ä¸­ï¼Œè¦å…»æˆå¯¹å…±äº«èµ„æºçš„è®¿é—®å¿…é¡»åŠ é”çš„æ„è¯†ã€‚

## ç»“è¯­
----------------------------------------
å¤§æ¦‚å…ˆåšè¿™ä¹ˆå¤šå†…å®¹ï¼Œå¦‚æœè¿˜æœ‰æ›´å¤šå†…å®¹ï¼Œæˆ‘ä¼šæ”¾åœ¨ç¬¬äºŒå¤©çš„blogé‡Œã€‚

---------------------------------------