# æ•°æ®åº“è¿æ¥æ± ä¸äº‹åŠ¡ç®¡ç†å®è·µ

## å‰è¨€
------------------------------
ğŸ˜° äº”ä¸€å·²ç»è¿‡å»ä¸€åŠäº†å—ï¼Œè¿™ç§äº‹æƒ…è¡¥è¯å•Š  
ä»Šå¤©æ¥ç ”ç©¶æ•°æ®åº“è¿æ¥æ± ã€‚

------------------------------

## æ—¥ç¨‹
------------------------------
ä»Šå¤©æ—©ä¸Šæœ‰ç‚¹æ‘¸é±¼ï¼Œä¸çŸ¥ä¸è§‰å°± 11 ç‚¹äº†ï¼Œæ˜æ˜èµ·å¾—ä¸ç®—æ™šå•Šã€‚  
æ€»ä¹‹æ¥çœ‹çœ‹æ•°æ®åº“è¿æ¥æ± ã€‚  
æ™šä¸Š 11ï¼š30ï¼Œä¸‹ç­ã€‚è½»è½»æ¾æ¾è§£å†³äº†æ³¨è§£å¼äº‹åŠ¡å’Œè¿æ¥ä¸Šä¸‹æ–‡ï¼Œæ„Ÿè§‰çˆ½é£äº†ğŸ¥µã€‚

------------------------------

## å­¦ä¹ å†…å®¹
------------------------------
### çœæµ
1. æ•°æ®åº“è¿æ¥æ± 
2. AOP åµŒå¥—é—®é¢˜ä¸ä¿®å¤
3. è¿æ¥ä¸Šä¸‹æ–‡å’Œæ³¨è§£å¼äº‹åŠ¡

### 1. æ•°æ®åº“è¿æ¥æ± 
#### 1ï¼‰åŸç†å‰–æ
ä»¥ **Druid** è¿æ¥æ± ä¸ºä¾‹ï¼š

##### a. çº¿ç¨‹æ± çš„åˆå§‹åŒ–
```mermaid
graph TD
    A[å¼€å§‹åˆå§‹åŒ–] --> B[æ£€æŸ¥é…ç½®å‚æ•°]
    B --> C[åˆ›å»ºåˆå§‹ç‰©ç†è¿æ¥]
    C --> D[å¡«å……ç©ºé—²è¿æ¥æ± ]
    D --> E[å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹]
    E --> F[åˆå§‹åŒ–å®Œæˆ]
    F --> G[ç­‰å¾…å¤–éƒ¨è¯·æ±‚]

    subgraph å‚æ•°æ£€æŸ¥
    B --> B1["æ ¡éªŒ maxActive > minIdle"]
    B --> B2["æ ¡éªŒ maxWait â‰¥ 0"]
    B --> B3[åŠ è½½ JDBC é©±åŠ¨]
    end

    subgraph åˆ›å»ºè¿æ¥
    C --> C1[å¾ªç¯åˆ›å»º minIdle ä¸ªè¿æ¥]
    C1 --> C2[DriverManager.getConnection]
    C2 --> C3[è®¾ç½®éš”ç¦»çº§åˆ«/è‡ªåŠ¨æäº¤]
    C3 --> C4[æ‰§è¡Œ initSql]
    end

    subgraph åå°çº¿ç¨‹
    E --> E1[åˆ›å»º DestroyTask çº¿ç¨‹]
    E --> E2[åˆ›å»º LogStatsThread]
    E --> E3[åˆ›å»º CreateTask çº¿ç¨‹]
    end
```

##### b. ä»çº¿ç¨‹æ± è·å–ä¸€ä¸ªè¿æ¥
```mermaid
graph TD
    A[è°ƒç”¨ getConnection] --> B{è¿æ¥æ± å·²åˆå§‹åŒ–?}
    B -->|æ˜¯| C[å°è¯•ä»ç©ºé—²é˜Ÿåˆ—è·å–]
    B -->|å¦| Z[æŠ›å‡º IllegalStateException]
    C --> D{è·å–åˆ°ç©ºé—²è¿æ¥?}
    D -->|æ˜¯| E[æ‰§è¡Œ testOnBorrow éªŒè¯]
    D -->|å¦| F{æ´»è·ƒè¿æ¥ < maxActive?}
    E -->|éªŒè¯é€šè¿‡| H[åŒ…è£…ä¸º PooledConnection]
    E -->|éªŒè¯å¤±è´¥| I[ä¸¢å¼ƒæ— æ•ˆè¿æ¥]
    I --> F
    F -->|æ˜¯| J[åˆ›å»ºæ–°ç‰©ç†è¿æ¥]
    F -->|å¦| K{ç­‰å¾… maxWait æ—¶é—´}
    J --> H
    K --> L{æœŸé—´æœ‰è¿æ¥é‡Šæ”¾?}
    L -->|æ˜¯| M[è·å–é‡Šæ”¾çš„è¿æ¥]
    L -->|å¦| N[æŠ›å‡ºè·å–è¶…æ—¶å¼‚å¸¸]
    M --> H
    H --> O[æ‰§è¡Œè¿‡æ»¤å™¨é“¾]
    O --> P[æ›´æ–°ç›‘æ§ç»Ÿè®¡]
    P --> Q[è¿”å›è¿æ¥ç»™è°ƒç”¨æ–¹]
```

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant Pool as è¿æ¥æ± 
    participant DB as æ•°æ®åº“
    
    App->>Pool: getConnection()
    Pool->>DB: åˆ›å»ºç‰©ç†è¿æ¥ï¼ˆå¦‚éœ€ï¼‰
    Pool-->>App: è¿”å› DruidPooledConnection
    App->>Pool: connection.close()
    Pool->>Pool: å›æ”¶è¿æ¥è‡³ç©ºé—²é˜Ÿåˆ—
    Note right of Pool: é‡ç½®è¿æ¥çŠ¶æ€
```

##### c. ä¸‰ä¸ªå®ˆæŠ¤çº¿ç¨‹æ˜¯è¿æ¥æ± çš„æ ¸å¿ƒçº¿ç¨‹
```mermaid
graph TD
    A[åº”ç”¨çº¿ç¨‹] -->|getConnection| B(è¿æ¥æ± æ ¸å¿ƒ)
    B --> C[DestroyTask]
    B --> D[CreateTask]
    B --> E[AsyncCloseThread]
    C --> F[ç‰©ç†å…³é—­è¿æ¥]
    D --> G[åˆ›å»ºæ–°è¿æ¥]
    E --> H[å¼‚æ­¥å…³é—­è¿æ¥]
    I[LogStatsThread] --> J[æ‰“å°çŠ¶æ€]
    K[MetricsCollector] --> L[ä¸ŠæŠ¥ç›‘æ§æ•°æ®]
```

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant Pool as è¿æ¥æ± 
    participant Thread as å®ˆæŠ¤çº¿ç¨‹
    
    App->>Pool: é‡Šæ”¾è¿æ¥
    Pool->>Thread: é€šçŸ¥ notEmpty.signal()
    Thread->>Pool: æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼©å®¹
    Pool->>DB: å…³é—­å¤šä½™è¿æ¥
    Thread->>Pool: æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹
    Pool->>DB: åˆ›å»ºæ–°è¿æ¥
```

é€šè¿‡å®šæ—¶æ¿€æ´»å®ˆæŠ¤çº¿ç¨‹ **DestroyTaskï¼ˆç¼©å®¹ï¼‰** æ¥å®ç°é‡Šæ”¾ç©ºé—²è¿æ¥ã€‚åœ¨éœ€è¦æ›´å¤šè¿æ¥æ—¶æ¿€æ´»å®ˆæŠ¤çº¿ç¨‹ **CreateTaskï¼ˆæ‰©å®¹ï¼‰** æ¥åˆ›å»ºæ–°è¿æ¥ã€‚

##### d. ä»ç­‰å¾…é˜Ÿåˆ—åˆ°ç©ºé—²é˜Ÿåˆ—/å¼‚æ­¥é”€æ¯çš„å·¥ä½œæœºåˆ¶
```mermaid
graph TD
    A[è¿æ¥å½’è¿˜] --> B{è¿æ¥æ˜¯å¦æœ‰æ•ˆ?}
    B -->|æœ‰æ•ˆ| C[æ”¾å…¥ç©ºé—²é˜Ÿåˆ—]
    B -->|æ— æ•ˆ| D[æ ‡è®°ä¸ºåºŸå¼ƒ]
    C --> E[é€šçŸ¥ç­‰å¾…çº¿ç¨‹]
    D --> F[åŠ å…¥å¼‚æ­¥é”€æ¯é˜Ÿåˆ—]
    F --> G[DestroyThread å¤„ç†]
    G --> H[ç‰©ç†å…³é—­è¿æ¥]
    E --> I[ç­‰å¾…çº¿ç¨‹è·å–è¿æ¥]
    I --> J{è·å–æˆåŠŸ?}
    J -->|æ˜¯| K[æ‰§è¡Œä¸šåŠ¡ SQL]
    J -->|å¦| L[é‡æ–°è¿›å…¥ç­‰å¾…]
```

#### 2ï¼‰åŸºç¡€è¿æ¥æ± å®ç°
è®¾è®¡ä¸Šä¾æ—§ä½¿ç”¨äº† **å•ä¾‹æ¨¡å¼**ï¼Œé€šè¿‡ç±»è·¯å¾„æ‰«æå™¨åŠ è½½é…ç½®ã€‚

```java
// å•ä¾‹å®ä¾‹
private static volatile HakimiConnectionPool instance;

// é…ç½®å‚æ•°
private final HakimiConfig hakimiConfig;

// è¿æ¥å­˜å‚¨ï¼ˆå­˜å‚¨åŸå§‹è¿æ¥ï¼‰
private final BlockingQueue<Connection> idleConnections;
private final Set<Connection> activeConnections;

// ç›‘æ§ç»Ÿè®¡
private final AtomicInteger createdCount = new AtomicInteger(0);
private final AtomicInteger waitCount = new AtomicInteger(0);
```

åœ¨è·å–è¿æ¥æ—¶æ£€æŸ¥åˆå§‹åŒ–ï¼Œå¹¶è¿›è¡Œæ‡’åŠ è½½ï¼š

```java
private final Object initLock = new Object();
private void ensureInitialized() throws SQLException, FileNotFoundException {
    // åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼ç¡®ä¿çº¿ç¨‹å®‰å…¨
    if (!initialized) {
        synchronized (initLock) {
            if (!initialized) {
                // 1. æ£€æŸ¥å•ä¾‹å®ä¾‹æ˜¯å¦å·²åˆ›å»º
                if (instance == null) {
                    instance = getInstance();
                }

                // 2. åˆå§‹åŒ–è¿æ¥æ± æ•°æ®ç»“æ„
                // åˆå§‹åŒ–æœ€å°ç©ºé—²è¿æ¥
                for (int i = 0; i < hakimiConfig.getMinIdle(); i++) {
                    idleConnections.add(createPhysicalConnection());
                }

                initialized = true;
                log.info("Connection pool initialized with {} idle connections", hakimiConfig.getMinIdle());
            }
        }
    }
}
```

è·å–è¿æ¥ï¼ˆç›®å‰æ²¡æœ‰é€šè¿‡å®ˆæŠ¤è¿›ç¨‹å¤„ç†ï¼‰ï¼š

```java
public Connection getConnection() throws SQLException, FileNotFoundException {
    ensureInitialized();

    Connection rawConn = null;
    try {
        // 1. å°è¯•è·å–ç©ºé—²è¿æ¥
        ...

        // 2. åˆ›å»ºæ–°è¿æ¥
        ...

        // 3. ç­‰å¾…å¯ç”¨è¿æ¥
        ...

        // éªŒè¯è¿æ¥æœ‰æ•ˆæ€§
        closeConnection(rawConn);
        createdCount.decrementAndGet();
        return getConnection(); // é€’å½’é‡è¯•

        activeConnections.add(rawConn);
        return createProxyConnection(rawConn);
    } catch (Exception e) {
        if (rawConn != null) {
            closeConnection(rawConn);
            createdCount.decrementAndGet();
        }
        throw e;
    }
}
```

##### 1. å°è¯•è·å–ç©ºé—²è¿æ¥ï¼šä»æ´»è·ƒè¿æ¥æ± ä¸­è·å–åŸå§‹è¿æ¥
```java
while ((rawConn = idleConnections.poll()) != null) {
    if (testConnection(rawConn)) {
        break;
    }
    closeConnection(rawConn);
    createdCount.decrementAndGet();
    rawConn = null;
}
```

é€šè¿‡ç®€å•çš„éªŒè¯æŸ¥è¯¢è¿æ¥æœ‰æ•ˆæ€§ï¼š

```java
// æµ‹è¯•è¿æ¥æœ‰æ•ˆæ€§
private boolean testConnection(Connection conn) {
    if (conn == null) return false;

    try {
        if (conn.isClosed()) {
            return false;
        }

        // éªŒè¯æŸ¥è¯¢
        try (Statement stmt = conn.createStatement()) {
            stmt.setQueryTimeout(1);
            return stmt.execute("/* ping */ SELECT 1");
        }
    } catch (SQLException e) {
        return false;
    }
}
```

##### 2. å½“ç›®å‰ç©ºé—²è¿æ¥ä¸è¶³æ—¶ï¼Œåˆ›å»ºæ–°çš„è¿æ¥
```java
if (rawConn == null) {
    while (createdCount.get() < hakimiConfig.getMaxSize()) {
        if (createdCount.compareAndSet(createdCount.get(), createdCount.get() + 1)) {
            try {
                rawConn = createPhysicalConnection();
                break;
            } catch (SQLException e) {
                createdCount.decrementAndGet();
                throw e;
            }
        }
    }
}
```

è¿™é‡Œä»æ•°æ®åº“ä¸­è·å–åˆ°åŸå§‹çš„ JDBC è¿æ¥ï¼š

```java
private Connection createPhysicalConnection() throws SQLException {
    Connection rawConn = DriverManager.getConnection(
        hakimiConfig.getUrl(),
        hakimiConfig.getUsername(),
        hakimiConfig.getPassword()
    );
    createdCount.incrementAndGet();

    try {
        rawConn.setAutoCommit(true);
        rawConn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);
        return rawConn;
    } catch (SQLException e) {
        closeConnection(rawConn);
        throw e;
    }
}
```

##### 3. å¦‚æœè¶…è¿‡å½“å‰æœ€å¤§è¿æ¥ä¸Šé™ï¼Œåˆ™ç­‰å¾…å¯ç”¨è¿æ¥
```java
if (rawConn == null) {
    waitCount.incrementAndGet();
    try {
        rawConn = idleConnections.poll(hakimiConfig.getMaxWaitMillis(), TimeUnit.MILLISECONDS); // ä¸¢åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“ idleConnections.off æ–¹æ³•è§¦å‘æ—¶ï¼Œä¼šæ¿€æ´»ä¼‘çœ çš„çº¿ç¨‹
        if (rawConn == null) {
            throw new SQLException("Wait timeout");
        }
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt(); // è®¾ç½®ä¸­æ–­æ ‡å¿—ï¼Œä¼ æ’­ä¸­æ–­é“¾
        throw new SQLException("Interrupted");
    } finally {
        waitCount.decrementAndGet();
    }
}
```

##### 4. æ·»åŠ åˆ°æ´»è·ƒè¿æ¥æ± ä¸­ï¼Œå¹¶è¿”å›åŒ…è£…åçš„ä»£ç†è¿æ¥å¯¹è±¡
```java
activeConnections.add(rawConn);
return createProxyConnection(rawConn);
```

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä»£ç†è¿æ¥å¯¹è±¡ï¼Ÿ  
è¿™æ˜¯å› ä¸ºè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥ç”±è¿æ¥æ± è¿›è¡Œç®¡ç†ï¼Œè€Œç›´æ¥å°†åŸå§‹è¿æ¥æš´éœ²ç»™ä¸šåŠ¡å±‚ä¼šå¸¦è¿æ¥æ± æ•°æ®ä¸åŒæ­¥çš„é£é™©ã€‚

```java
private Connection createProxyConnection(Connection rawConn) {
    return (Connection) Proxy.newProxyInstance(
            PooledConnection.class.getClassLoader(),
            new Class<?>[]{Connection.class, PooledConnection.class}, // å®ç°çš„æ¥å£åˆ—è¡¨
            new ConnectionInvocationHandler(rawConn) // æ–¹æ³•æ‹¦æˆªå™¨
    );
}

// æ–¹æ³•æ‹¦æˆªç±»
private class ConnectionInvocationHandler implements InvocationHandler {
    private final Connection rawConnection;
    private volatile boolean closed = false;
    private volatile long lastUsedTime = System.currentTimeMillis();

    public ConnectionInvocationHandler(Connection rawConn) {
        this.rawConnection = rawConn;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        lastUsedTime = System.currentTimeMillis();

        switch (method.getName()) {
            case "close" -> {
                if (!closed) {
                    closed = true;
                    releaseConnection((Connection) proxy); // è°ƒç”¨å®é™…æ–¹æ³•å°†è¿æ¥è¿”å›åˆ°è¿æ¥æ± ã€‚
                }
                return null;
            }
            case "isClosed" -> {
                return closed;
            }
            case "getRawConnection" ->
                    throw new UnsupportedOperationException("Direct access to raw connection is prohibited");
            case "getLastUsedTime" -> {
                return lastUsedTime;
            }
            case "realClose" -> {
                closeConnection(rawConnection);
                createdCount.decrementAndGet();
                return null;
            }
        }

        if (closed) {
            throw new SQLException("Connection already closed");
        }

        try {
            return method.invoke(rawConnection, args);
        } catch (InvocationTargetException e) {
            throw e.getCause();
        }
    }
}
```

```java
// é‡Šæ”¾è¿æ¥
private void releaseConnection(Connection proxyConn) {
    try {
        InvocationHandler handler = Proxy.getInvocationHandler(proxyConn);
        if (handler instanceof ConnectionInvocationHandler invocationHandler) {
            Connection rawConn = invocationHandler.rawConnection;

            synchronized (activeConnections) {
                if (!activeConnections.remove(rawConn)) {
                    return; // è¿æ¥å·²è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾
                }
            }

            if (testConnection(rawConn)) {
                resetConnection(rawConn);
                if (!idleConnections.offer(rawConn)) {
                    closeConnection(rawConn); // å…³é—­åŸå§‹è¿æ¥
                    createdCount.decrementAndGet();
                }
            } else {
                closeConnection(rawConn);
                createdCount.decrementAndGet();
            }
        }
    } catch (Exception e) {
        log.error("Error releasing connection", e);
    }
}
```

æ¥ä¸‹æ¥å°±æ˜¯è¦æ£€æŸ¥å¹¶å‘å®‰å…¨æ€§ï¼Œå¹¶å¯¹è¿æ¥æ± çš„æ•ˆç‡è¿›è¡Œä¼˜åŒ–ã€‚

### 2. AOP åµŒå¥—é—®é¢˜ä¸ä¿®å¤
åœ¨æˆ‘æ˜¨å¤©çš„é€šçŸ¥é“¾é€»è¾‘ä¸­ï¼Œæˆ‘å¿½ç•¥äº† AOP çš„åµŒå¥—é—®é¢˜ï¼Œå¯¼è‡´äº†åŸå§‹æ–¹æ³•è¢«å¤šæ¬¡è°ƒç”¨ã€‚

```java
// åˆ›å»ºè¿æ¥ç‚¹
ProceedingJoinPoint joinPoint = new ProceedingJoinPoint(target, method, args);

// æ‰§è¡Œé€šçŸ¥é“¾
Object result = null;
for (AdviceWrapper advice : matchedAdvices) {
    result = advice.invoke(joinPoint);
}
return result;
```

è§£å†³æ–¹æ³•æ˜¯å°†é€šçŸ¥é“¾ä¹Ÿä½œä¸º `joinPoint` çš„å‚æ•°ï¼Œé€’å½’æ‰§è¡Œæ–¹æ³•ï¼Œè®°å½•å½“å‰é€šçŸ¥æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°ï¼Œåªæœ‰é€šçŸ¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œæ‰æ‰§è¡ŒåŸå§‹çš„æ–¹æ³•ã€‚

```java
@Override
public Object proceed() throws Throwable {
    if (currentPosition < advices.size()) {
        // æ‰§è¡Œä¸‹ä¸€ä¸ªåˆ‡é¢
        AdviceWrapper currentAdvice = advices.get(currentPosition++);
        return currentAdvice.invoke(this); // é€’å½’è°ƒç”¨
    } else {
        // æ‰€æœ‰åˆ‡é¢æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•
        return method.invoke(target, args);
    }
}
```

### 3. è¿æ¥ä¸Šä¸‹æ–‡å’Œæ³¨è§£å¼äº‹åŠ¡
åœ¨ä¹‹å‰ç¼–å†™çš„ Jdbc å·¥å…·ç±»ä¸­ï¼Œè¿æ¥æ˜¯åœ¨ service å±‚ä¸­æ‰‹åŠ¨è·å–çš„ï¼Œè¿™æ ·ä¸ä»…ä¼šé€ æˆä»£ç å†—ä½™ï¼Œè¿˜ä¼šæ— ç¼˜æ— æ•…å¢åŠ è¿æ¥çš„å ç”¨æ—¶é—´ï¼Œæµªè´¹æ•ˆç‡ã€‚é€šè¿‡ `ThreadLocal` å‚¨å­˜è¿æ¥èµ„æºï¼Œå¯ä»¥è½»æ¾åœ°ä¼ é€’å½“å‰çº¿ç¨‹ä½¿ç”¨çš„è¿æ¥ã€‚

#### ConnectionContext
```java
/**
 * è¿æ¥ä¸Šä¸‹æ–‡ï¼ˆåŸºäº ThreadLocalï¼‰
 */
public class ConnectionContext {
    private static final ThreadLocal<Connection> connectionHolder = new ThreadLocal<>();

    public static Connection getConnection() throws SQLException {
        Connection conn = connectionHolder.get();
        if (conn == null) {
            throw new IllegalStateException("No active transaction connection found!");
        }
        return conn;
    }

    public static boolean isActive() {
        try {
            Connection conn = connectionHolder.get();
            return conn != null && !conn.isClosed();
        } catch (SQLException e) {
            return false;
        }
    }

    public static void bindConnection(Connection conn) {
        connectionHolder.set(conn);
    }

    public static void unbindConnection() {
        connectionHolder.remove();
    }
}
```

#### JdbcUtils
```java
// ä¼˜å…ˆä»äº‹åŠ¡ä¸Šä¸‹æ–‡è·å–è¿æ¥ï¼Œæ²¡æœ‰åˆ™ä»è¿æ¥æ± è·å–
public static Connection getConnection() throws SQLException, FileNotFoundException {
    try {
        // 1. å°è¯•ä»äº‹åŠ¡ä¸Šä¸‹æ–‡è·å–
        Connection txConn = ConnectionContext.getConnection();
        if (txConn != null && !txConn.isClosed()) {
            return txConn;
        }
        // 2. æ²¡æœ‰äº‹åŠ¡åˆ™ä»è¿æ¥æ± è·å–
        return HakimiConnectionPool.getInstance().getConnection();
    } catch (IllegalStateException e) {
        // ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–æ—¶å›é€€åˆ°è¿æ¥æ± 
        return HakimiConnectionPool.getInstance().getConnection();
    }
}
```

å®Œæˆäº†è¿æ¥ä¸Šä¸‹æ–‡ç»‘å®šå™¨ï¼Œå°±å¯ä»¥å¼€å§‹ç€æ‰‹æ³¨è§£å¼äº‹åŠ¡ã€‚

#### äº‹åŠ¡æ³¨è§£ç±»
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface KatTransactional {
    /**
     * æŒ‡å®šäº‹åŠ¡è¶…æ—¶æ—¶é—´(ç§’)ï¼Œé»˜è®¤-1è¡¨ç¤ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼
     */
    int timeout() default -1;

    /**
     * æŒ‡å®šäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œé»˜è®¤-1è¡¨ç¤ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼
     */
    int isolation() default -1;

    /**
     * æŒ‡å®šäº‹åŠ¡æ˜¯å¦åªè¯»ï¼Œé»˜è®¤false
     */
    boolean readOnly() default false;
}
```

#### äº‹åŠ¡å¤„ç†ï¼ˆåŸºäº AOPï¼‰
```java
@KatAspect
public class TransactionAspect {

    @KatAround("@annotation(com.anyview.xiazihao.annotation.KatTransactional)")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        Connection conn = null;
        try {
            // 1. è·å–æ•°æ®æºè¿æ¥
            conn = HakimiConnectionPool.getInstance().getConnection();
            conn.setAutoCommit(false);

            // 2. ç»‘å®šè¿æ¥åˆ°å½“å‰çº¿ç¨‹
            ConnectionContext.bindConnection(conn); // ç¡®ä¿æ‰§è¡Œäº‹åŠ¡çš„è¿æ¥ä¸€è‡´æ€§

            // 3. æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
            Object result = joinPoint.proceed();

            // 4. æäº¤äº‹åŠ¡
            conn.commit();
            return result;

        } catch (Throwable e) {
            // 5. å›æ»šäº‹åŠ¡
            if (conn != null) conn.rollback();
            throw e;
        } finally {
            // 6. æ¸…ç†èµ„æº
            ConnectionContext.unbindConnection();
            if (conn != null) conn.close();
        }
    }
}
```

å› ä¸ºæˆ‘åœ¨å‰é¢å·²ç»å®ç°äº† AOP æ‰«æï¼Œæ‰€ä»¥åªéœ€è¦å¤„ç†ä¸€ä¸‹ `@annotation(com.anyview.xiazihao.annotation.KatTransactional)` åˆ‡é¢è¡¨è¾¾å¼çš„è½¬ä¹‰å°±å¯ä»¥äº†ã€‚

#### AspectProcessor ç±»
```java
private boolean matchesPointcut(String pointcut, Method method) {
    // æ³¨è§£åŒ¹é…é€»è¾‘
    if (pointcut.startsWith("@annotation(")) {
        String annotationName = pointcut.substring("@annotation(".length(), pointcut.length() - 1);
        return hasAnnotation(method, annotationName);
    }

    // åŸæœ‰æ–¹æ³•ç­¾ååŒ¹é…
    String methodSignature = buildMethodSignature(method);
    return matchesPointcut(pointcut, methodSignature);
}

// æ£€æŸ¥æ–¹æ³•æ˜¯å¦å¸¦æœ‰æŒ‡å®šæ³¨è§£
private boolean hasAnnotation(Method method, String annotationName) {
    try {
        Class<? extends Annotation> annotationClass =
                (Class<? extends Annotation>) Class.forName(annotationName);
        return method.isAnnotationPresent(annotationClass);
    } catch (ClassNotFoundException e) {
        return false;
    }
}

// å¤„ç†æ³¨è§£åˆ‡ç‚¹
private Pattern compileAnnotationPointcut(String expression) {
    // æå–æ³¨è§£å…¨é™å®šåï¼Œå¦‚ "@annotation(com.example.Transactional)" -> "com.example.Transactional"
    String annotationName = expression.substring("@annotation(".length(), expression.length() - 1);

    // åŒ¹é…æ‰€æœ‰å¸¦æœ‰è¯¥æ³¨è§£çš„æ–¹æ³•
    return Pattern.compile(".*" + Pattern.quote(annotationName) + ".*");
}
```

------------------------------

## ç»“è¯­
------------------------------
æ˜å¤©å­¦ JMeterï¼

------------------------------