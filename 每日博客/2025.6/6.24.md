# Nodejs å­¦ä¹ ä¹‹æ—…ï¼šæ¨¡å—åŒ–ä¸ Express æ¡†æ¶å…¥é—¨

## å‰è¨€
----------------------------------------
æ—©èµ·åˆå¤±è´¥äº†ï¼Œæˆ‘å®šäº†8ç‚¹çš„é—¹é’Ÿå•Šï¼Œè¿™é—¹é’Ÿæ€ä¹ˆæ²¡å£°å‘¢ã€‚ç®€å•ç»™æ˜¨å¤©çš„blogæ”¶ä¸ªå°¾ï¼Œä»Šå¤©ç»§ç»­å­¦Nodejsã€‚

## æ—¥ç¨‹
----------------------------------------
### 6.25
æ™šä¸Š6ç‚¹ï¼Œæ„Ÿè§‰æ²¡ä»€ä¹ˆå­¦ä¹ çš„åŠ¨åŠ›ï¼Œè·³äº†ä¸€éƒ¨åˆ†å†…å®¹ã€‚ç›®å‰è¿›åº¦æ¥åˆ°äº†ä¸€åŠã€‚

### 6.27
ä»Šå¤©è¿›è¡Œå®Œæˆexpresså‰©ä¸‹çš„éƒ¨åˆ†ã€‚

## å­¦ä¹ å†…å®¹
----------------------------------------
### çœæµ
1. Nodejs æ¨¡å—åŒ–
2. expressæ¡†æ¶å…¥é—¨

### 1. Nodejs æ¨¡å—åŒ–
æ¨¡å—åŒ–ï¼Œä¹Ÿå¯ä»¥è¢«è®¤ä¸ºæ˜¯é€šä¿—çš„å¤šæ–‡ä»¶è®¾è®¡ã€‚åœ¨Nodejsä¸­ï¼Œé€šè¿‡`module.exports`æ¥æš´éœ²æ¨¡å—ã€‚

```javascript
const doTest = () => {
    console.log('I do a Test');
}
// exports.doTest = doTest; //ä¸module.exportsçš„åŠŸèƒ½ç›¸åŒ
module.exports = {
    doTest,
}
```

é€šè¿‡`require`å¯¼å…¥æ¨¡å—ï¼š
```javascript
const mode1 = require('./test')
console.log(mode1);
mode1.doTest();
```

**æ³¨æ„**ï¼šè‡ªå®šä¹‰æ¨¡å—éœ€è¦å†™æ˜æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¦‚`./test`ï¼Œè€Œ`test`ä¸è¢«å…è®¸ï¼Œå› ä¸ºè¿™æ˜¯å†…éƒ¨æ¨¡å—çš„å†™æ³•ã€‚

é»˜è®¤å¯å¯¼å…¥çš„æ–‡ä»¶æ˜¯jså’ŒJSONï¼Œå¯¼å…¥å…¶ä»–æ–‡ä»¶ä¼šä½œä¸ºjsæ–‡ä»¶è¿›è¡Œå¤„ç†ã€‚ä¹Ÿå¯ä»¥å¯¼å…¥ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼š
```javascript
const mode2 = require('./testdir')
console.log(mode2);
mode2.doTest();
```

é»˜è®¤ä¼šå¯¼å…¥æ–‡ä»¶å¤¹ä¸­`package.json`çš„`main`æŒ‡å‘çš„æ¨¡å—ï¼š
```json
{
    "main": "test.js"
}
```

ä»¥ä¸‹æ˜¯æ›´å®Œæ•´çš„å¯»æ‰¾è¿‡ç¨‹ï¼š
```mermaid
flowchart TD
    A[å¯¼å…¥æ–‡ä»¶å¤¹è·¯å¾„] --> B{æ˜¯å¦å­˜åœ¨ package.json?}
    B -->|æ˜¯| C{æ˜¯å¦æœ‰ main å­—æ®µ?}
    B -->|å¦| D
    C -->|æ˜¯| E[åŠ è½½ main æŒ‡å®šçš„æ–‡ä»¶]
    C -->|å¦| D
    D --> F{æ˜¯å¦å­˜åœ¨ index.js?}
    F -->|æ˜¯| G[åŠ è½½ index.js]
    F -->|å¦| H{æ˜¯å¦å­˜åœ¨ index.json?}
    H -->|æ˜¯| I[åŠ è½½ index.json]
    H -->|å¦| J[æŠ›å‡ºé”™è¯¯: Cannot find module]
```

### 2. expressæ¡†æ¶å…¥é—¨
åŸºäºnodejsçš„WEBåº”ç”¨å¼€å‘æ¡†æ¶ã€‚[npmjs.com/package](https://www.npmjs.com/package) æŸ¥è¯¢å…³äºä¾èµ–çš„apiä»¥åŠå…¶ä»–ä¿¡æ¯ã€‚

#### 0ï¼‰å¼•å…¥ä¾èµ–
åˆå§‹åŒ–npmåŒ…ï¼š
```bash
npm init
```

å¯¼å…¥express 4åŒ…ï¼ˆç›®å‰æœ€æ–°æ˜¯5ï¼Œä½†æ˜¯å…¼å®¹æ€§æ²¡æœ‰4å¥½ï¼‰ï¼š
```bash
npm install express@4
```

#### 1ï¼‰å…¥é—¨ç¨‹åº
```javascript
//å¯¼å…¥express
const express = require('express')

//åˆ›å»ºåº”ç”¨å¯¹è±¡
const app = express();

//åˆ›å»ºè·¯ç”±
app.get('/', (req, rep) => {
    rep.end('hello express');
})

app.get('/*', (req, rep) => {
    rep.status(404).end('404 Not Found');
})

//ç›‘å¬ç«¯å£
app.listen(9000, () => {
    console.log('start')
})
```

**è·¯ç”±**æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œå®ƒç¡®å®šäº†åº”ç”¨ç¨‹åºåº”è¯¥æ€æ ·å“åº”è¯·æ±‚ã€‚

#### 2ï¼‰å‚æ•°è·å–
expressæ”¯æŒå¤§éƒ¨åˆ†nodejsåŸç”Ÿçš„httpè¯·æ±‚apiï¼Œå¦‚ï¼š
```javascript
console.log(req.method);
console.log(req.url);
console.log(req.httpVersion);
console.log(req.headers);
```

è·å–è¯·æ±‚å‚æ•°ï¼š
```javascript
app.get('/', (req, res) => {
    console.log(req.path); //è¯·æ±‚è·¯å¾„
    console.log(req.query); //è¯·æ±‚å‚æ•°
    console.log(req.body); //è¯·æ±‚ä½“
    console.log(req.get('host')); //è¯·æ±‚å¤´
    res.end();
})
```

è·å–è¯·æ±‚ä½“ï¼š
ä½¿ç”¨`console.log(req.body)`è·å–è¯·æ±‚ä½“æ—¶å¾—åˆ°çš„æ˜¯`undefined`ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨`body-parser`å·¥å…·ã€‚

å®‰è£…ä¾èµ–ï¼š
```bash
npm i body-parser
```

å¯¼å…¥æ¨¡å—ï¼š
```javascript
const bodyParser = require('body-parser');
```

è§£æJSONï¼š
```javascript
const jsonParser = bodyParser.json()
```

è§£æqueryString --å¯¹åº” HTML è¡¨å•æäº¤æˆ– axios å‘é€ URL-encoded æ•°æ®ï¼š
```javascript
const urlencodedParser = bodyParser.urlencoded({extended:false})
```

ä½œä¸ºè·¯ç”±ä¸­é—´ä»¶ä½¿ç”¨ï¼š
```javascript
app.post('/body',urlencodedParser,(req,res) =>{
    console.log('post');
    console.log(req.body);
})
```

è·å–è·¯ç”±å‚æ•° `:id`æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå¯ä»¥åŒ¹é…ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚`test1234`ï¼š
```javascript
app.get('/:id/html', (req, res) => {
    console.log(req.params.id)
    res.end();
})
```

#### 3ï¼‰å“åº”è®¾ç½®
```javascript
app.get('/', (req, res) => {
    res.status(203); //è®¾ç½®å“åº”ç 
    res.set('test', 'header'); //å“åº”å¤´
    res.send('è‡ªåŠ¨è®¾ç½®ä¸­æ–‡å­—ç¬¦é›†'); //å“åº”ä½“
})
```

ä¹Ÿå¯ä»¥å†™æˆé“¾å¼ç¼–ç¨‹çš„æ¨¡å¼ï¼š
```javascript
res.status(203).set('test', 'header').send('è‡ªåŠ¨è®¾ç½®ä¸­æ–‡å­—ç¬¦é›†');
```

**é‡å®šå‘redirect**ï¼šä¼šå°†è¯·æ±‚è·¯å¾„é‡å®šå‘ã€‚
```javascript
app.get('/home', (req, res) => {
    res.redirect('/test')
});
```

ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¤–éƒ¨è¿æ¥ï¼š
```javascript
app.get('/baidu', (req, res) => {
    res.redirect('http://baidu.com')
});
```

**ä¸‹è½½å“åº”**ï¼šè§¦å‘æµè§ˆå™¨çš„ä¸‹è½½è¡Œä¸ºã€‚
```javascript
res.download(__dirname + '/test.txt');
```

**JSONå“åº”**ï¼š
```javascript
res.json({
    name: 'heyi',
    age: 18
});
```

**æ–‡ä»¶å“åº”**ï¼š
```javascript
res.sendFile(__dirname + '/test.txt');
```

#### 4ï¼‰ä¸­é—´ä»¶
æœ¬è´¨æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨æœºåˆ¶ä¸Šç±»ä¼¼äºè¿‡æ»¤å™¨ã€‚

å®šä¹‰ä¸­é—´ä»¶ï¼š
```javascript
const middleWare = (req, res, next) => {
    console.log('doing middleWare');
    next(); //æ”¾è¡Œ
}
```

ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ï¼Œ`(req, res, next)`æ˜¯å›ºå®šçš„å‚æ•°ï¼Œæœ€åè¦é€šè¿‡`next`æ”¾è¡Œã€‚

**å…¨å±€ä¸­é—´ä»¶**ï¼šå°†å‡½æ•°äº¤ç»™appä½¿ç”¨ï¼Œä»»ä½•è·¯ç”±çš„åŒ¹é…éƒ½ä¼šè§¦å‘ã€‚
```javascript
app.use(middleWare);
```

**è·¯ç”±ä¸­é—´ä»¶**ï¼šä½œä¸ºæŒ‡å®šè·¯ç”±çš„å‚æ•°ï¼ŒåŒ¹é…æ—¶è§¦å‘ã€‚
```javascript
app.get('/', middleWare, (req, res) => {
    res.end();
})
```

**é™æ€ä¸­é—´ä»¶**ï¼šå“åº”é™æ€èµ„æºã€‚
```javascript
app.use(express.static(__dirname + '/public'));
```

**æ³¨æ„**ï¼š
1. é»˜è®¤æ‰“å¼€`index.html`ã€‚
2. ä¼šå°è¯•åŒ¹é…æ ¹è·¯å¾„ï¼Œå¦‚æœæœ‰åŒ¹é…æ ¹è·¯å¾„çš„è·¯ç”±ï¼Œè°å…ˆåŒ¹é…è°å“åº”ï¼ˆä»£ç ä»ä¸Šåˆ°ä¸‹ï¼‰ã€‚

#### 5ï¼‰é˜²ç›—é“¾
åœ¨å›¾ç‰‡ç­‰å¸¦è¿æ¥çš„ç½‘é¡µèµ„æºï¼Œåœ¨è¯·æ±‚å¤´ä¸­ä¼šå¸¦æœ‰`referer`ï¼šè¯·æ±‚æºçš„IPåœ°å€ã€‚

```html
<body>
    <h1>æœ‹å‹ä½ å¥½</h1>
    <img src="http://127.0.0.1:9000/66c6138a0385170fc1d0f42a33e7547b326268855.jpg" alt="">
</body>
```

å¯ä»¥è®¾ç½®å…¨å±€ä¸­é—´ä»¶ï¼Œå¯¹`referer`è¿›è¡Œæ£€æŸ¥ï¼Œæ¥è¾¾åˆ°è®¾ç½®è®¿é—®æƒé™çš„æ•ˆæœã€‚
```javascript
app.use((req,res,next)=>{
    let referer = req.get('referer');
    if(referer){
        let url = new URL(referer);
        let hostname = url.hostname;
        if(hostname !== '127.0.0.1'){
            res.send(`<h1>ä½ ä¸æ˜¯æˆ‘æŒ‡å®šçš„è®¿é—®æº<h1>`)
            return;
        } 
    }
    next();
})
```

#### 6ï¼‰æ¨¡æ¿å¼•æ“
æ¨¡æ¿å¼•æ“ç”¨äºåˆ†ç¦»ç”¨æˆ·ç•Œé¢å’Œä¸šåŠ¡æ•°æ®ï¼ŒEJSæ˜¯å…¶ä¸­ä¸€ç§ã€‚

å®‰è£…EJSï¼š
```bash
npm i ejs
```

ç®€å•ç¤ºä¾‹ï¼š
```javascript
const ejs = require('ejs');
let data = 'æµ‹è¯•æ•°æ®';
let result = ejs.render('æˆ‘æ˜¯<%= data %>',{data:data});
```

åœ¨EJSæ¨¡å—ä¸­ï¼Œ`<% %>`æ ‡ç­¾å†…çš„ä»£ç ä¼šè¢«è§†ä¸ºJsä»£ç æ‰§è¡Œï¼ˆå®ƒæ”¯æŒå®Œå…¨çš„JSè¯­æ³•ï¼‰ã€‚
- `<%= %>`è¾“å‡ºè½¬ä¹‰åçš„å€¼
- `<%- %>`è¾“å‡ºåŸå§‹çš„HTML
- `<%# %>`æ³¨é‡Š
- `<%%`è¾“å‡ºå­—é¢é‡`'<%'`

ç¤ºä¾‹ï¼šif-elseè¯­æ³•
```javascript
let isLogin = true;
console.log(
    ejs.render(`
        <% if(isLogin){ %>
        <span>å·²ç»ç™»å½•</span>
        <% }else{ %>
        <span>ä½ éœ€è¦ç™»å½•</span>
        <% }%>  
    `,{isLogin:isLogin})
)
```

ejsä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨å¯¼å…¥çš„htmlæ–‡ä»¶ï¼š
```javascript
const fs = require('fs');
let arr = [1,2,3,4,5,6,7,8]
let html = fs.readFileSync(__dirname+'/6-test.html').toString();

console.log(
    ejs.render(html,{arr:arr})
)
```

`6-test.html`ï¼š
```html
<!DOCTYPE html>
.....
<body>
    <ul>
        <% arr.forEach(item=>{ %>
        <li><%= item %></li>
        <% })%>
    </ul>
</body>
</html>
```

æœ¬è´¨æ˜¯ä½¿ç”¨äº†Stringæ ¼å¼htmlï¼Œä¸ç›´æ¥ä½¿ç”¨æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚

ejsä¹Ÿæ”¯æŒåœ¨expressä¸­ä½¿ç”¨ï¼š
```javascript
const express = require('express')
const path = require('path')
const app = express()

//è®¾ç½®æ¨¡æ¿å¼•æ“
app.set('view engine','ejs');

//è®¾ç½®æ¨¡æ¿æ–‡ä»¶ä½ç½®
app.set('views',path.resolve(__dirname,'./views'))

//åˆ›å»ºè·¯ç”±
app.get('/home',(req,res)=>{
    let title = 'æµ‹è¯•æ ‡é¢˜';
    //æ¨¡æ¿æ–‡ä»¶åï¼Œæ•°æ®
    res.render('test',{title});
});

app.listen(9000,()=>{
})
```

#### 7ï¼‰express-generator
expressçš„åº”ç”¨ç”Ÿæˆå·¥å…·ï¼Œç”¨äºå¿«é€Ÿç”Ÿæˆåº”ç”¨æ¨¡æ¿ã€‚

å…¨å±€å®‰è£…ï¼š
```bash
npm i -g express-generator
```

åˆå§‹åŒ–npmåŒ…ï¼š
```bash
npm init
```

åˆ›å»ºæ¨¡æ¿ï¼Œå¹¶æ·»åŠ å¯¹ejsçš„æ”¯æŒï¼š
```bash
express -e
```

å¯åŠ¨å‘½ä»¤ï¼š
```bash
npm run start
```

#### 8ï¼‰æ–‡ä»¶ä¸Šä¼ å¤„ç†
`upload.ejs`ï¼š
```html
<!DOCTYPE html>
<html lang="en">
......
<body>
    <form action="/upload" method="post" enctype="multipart/form-data">
        ç”¨æˆ·åï¼š<input type="text" name="username"><br/>
        å¤´åƒï¼š<input type="file" name="uploadedfile">
        <button>æäº¤</button>
    </form>
</body>
</html>
```

æ³¨æ„è¦å°†è®¾ç½®`enctype`ä¸ºå¤šæ–‡ä»¶æ•°æ®ã€‚

è¿™é‡Œä½¿ç”¨äº†`formidable`å·¥å…·è¿›è¡Œæ–‡ä»¶å¤„ç†ï¼š
```bash
npm i formidable
```

`upload.js`ï¼š
```javascript
const express = require('express');
const router = express.Router();

router.get('/',(req,res)=>{
    res.render('upload');
})

//å¤„ç†æ–‡ä»¶ä¸Šä¼ 
const {formidable} = require('formidable');
router.post('/',(req,res,next)=>{
    const form = formidable({
        multiples: true,
        //ä¿å­˜ç›®å½•
        uploadDir:__dirname+'./../public/images',
        //ä¿æŒæ–‡ä»¶åç¼€
        keepExtensions: true
    })
    //è§£æè¯·æ±‚æŠ¥æ–‡
    form.parse(req,(err,fields,files)=>{
        if(err) {
            next(err);
            return;
        }
        console.log(fields);
        console.log(files);

        //ä¿å­˜url
        let url = '/images/' + files.uploadedfile[0].newFilename;
        console.log(url)
        res.send(url); 
    })
})

module.exports = router;
```

## ç»“è¯­
----------------------------------------
6.27ç»“çš„å°¾ï¼Œåˆèººäº†ä¸¤å¤©ğŸ«¥