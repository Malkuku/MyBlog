# ã€ŠæŠ€æœ¯å­¦ä¹ ç¬”è®°ï¼šSwaggerã€SpringBooté…ç½®ä¸AOPå®è·µã€‹

## å‰è¨€
æ˜¨å¤©ç†¬æ­»æˆ‘äº†ï¼Œmdï¼Œèˆå‹ä¸ç¡è§‰æé‚£æ•²é¼ æ ‡ï¼Œbydå“ªé‡Œä¹°çš„é‚£ä¹ˆå“çš„é¼ æ ‡ï¼Œé“›é“›é“›æŠŠæˆ‘è¡€å‹éƒ½æ•²é«˜äº†ï¼Œæˆ‘æƒ³æ‰¾éƒ½æ‰¾ä¸åˆ°ã€‚åˆè¦åœ¨ç¡çœ ä¸ŠæŠ•èµ„äº†ã€‚
å¼€å§‹è°ƒæ•´ç”Ÿç‰©é’Ÿçš„è®¡åˆ’ï¼Œä»Šå¤©å¾ˆå›°ï¼Œä½†æ˜¯å¿…é¡»é¡¶åˆ°æ™šä¸Šæ‰èƒ½ç¡è§‰ï¼Œå†é¡¶ä¸ªä¸€ä¿©å¤©å°±å¥½äº†ã€‚
bydèˆå‹æœ€å¥½æ—©ç‚¹å›å»ï¼Œä¸ç„¶ç•™ä½ å’Œæˆ‘ï¼Œä½ çœ‹æˆ‘æŠŠä¸æŠŠä½ å½“æ—¥æœ¬äººæ•´ã€‚

## æ—¥ç¨‹
9ï¼š00ï¼Œå¾ˆå›°ï¼Œå…ˆè¶ç€è¿˜æœ‰ç‚¹çŠ¶æ€å­¦ä¼šä¹ ã€‚
22ï¼š42ï¼Œåˆšå¥½å­¦å®ŒDay3çš„å†…å®¹ï¼Œå†™ä¼šç¬”è®°å°±å¯ä»¥å‡†å¤‡ç¡è§‰äº†ã€‚å›°äº†ä¸€å¤©äº†ï¼Œä»Šå¤©èˆå‹åº”è¯¥æ¶å¿ƒä¸åˆ°æˆ‘äº†

## å­¦ä¹ å†…å®¹

### ã€Šçœæµã€‹
1. Swagger
2. SpringBoot å¤šé…ç½®æ–‡ä»¶ï¼Œé…ç½®ç±»
3. SpringAOP å®ç°è‡ªåŠ¨åŒ–å­—æ®µå¡«å……
4. SpringBoot æ¶ˆæ¯è½¬æ¢å™¨
5. åŸºäºBeanç®¡ç†çš„å·¥å…·ç±»è®¾è®¡

### 1.Swagger
æ ¹æ®ä»£ç åå°„è‡ªåŠ¨åŒ–ç”Ÿæˆæ¥å£å¹¶è¿›è¡Œåœ¨çº¿è°ƒè¯•ã€‚

å¯¼å…¥ä¾èµ–
```xml
<knife4j>3.0.2</knife4j>
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-spring-boot-starter</artifactId>
    <version>${knife4j}</version>
</dependency>
```

åœ¨é…ç½®ç±»è¿›è¡Œç›¸å…³é…ç½®
```java
/**
 * é…ç½®ç±»ï¼Œæ³¨å†Œwebå±‚ç›¸å…³ç»„ä»¶
 */
@Configuration
@Slf4j
public class WebMvcConfiguration extends WebMvcConfigurationSupport {

    @Autowired
    private JwtTokenAdminInterceptor jwtTokenAdminInterceptor;

    /**
     * é€šè¿‡knife4jç”Ÿæˆæ¥å£æ–‡æ¡£
     * @return
     */
    @Bean
    public Docket docket() {
        ApiInfo apiInfo = new ApiInfoBuilder()
                .title("è‹ç©¹å¤–å–é¡¹ç›®æ¥å£æ–‡æ¡£")
                .version("2.0")
                .description("è‹ç©¹å¤–å–é¡¹ç›®æ¥å£æ–‡æ¡£")
                .build();
        Docket docket = new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(apiInfo)
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.sky.controller"))
                .paths(PathSelectors.any())
                .build();
        return docket;
    }

    /**
     * è®¾ç½®é™æ€èµ„æºæ˜ å°„
     * @param registry
     */
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/doc.html").addResourceLocations("classpath:/META-INF/resources/");
        registry.addResourceHandler("/webjars/**").addResourceLocations("classpath:/META-INF/resources/webjars/");
    }
}
```

å¸¸ç”¨æ³¨è§£
| æ³¨è§£               | è¯´æ˜                                       |
|--------------------|--------------------------------------------|
| `@Api`             | ç”¨åœ¨ç±»ä¸Šï¼Œä¾‹å¦‚Controllerï¼Œè¡¨ç¤ºå¯¹ç±»çš„è¯´æ˜     |
| `@ApiModelProperty` | ç”¨åœ¨ç±»ä¸Šï¼Œä¾‹å¦‚Entityã€DTOã€VO               |
| `@ApiModelProperty` | ç”¨åœ¨å±æ€§ä¸Šï¼Œæè¿°å±æ€§ä¿¡æ¯                   |
| `@ApiOperation`    | ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œä¾‹å¦‚Controllerçš„æ–¹æ³•ï¼Œè¯´æ˜æ–¹æ³•çš„ç”¨é€”ã€ä½œç”¨ |

### 2.SpringBoot å¤šé…ç½®æ–‡ä»¶ï¼Œé…ç½®ç±»
1ï¼‰SpringBootæ˜¯å¯ä»¥åœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨å…¶ä»–é…ç½®æ–‡ä»¶çš„ã€‚
application.yml
```yaml
spring:
  profiles:
    active: dev #
  main:
    allow-circular-references: true
  datasource:
    druid:
      driver-class-name: ${sky.datasource.driver-class-name} #é€šè¿‡æ’å€¼è¡¨è¾¾å¼å¼•ç”¨
      url: jdbc:mysql://${sky.datasource.host}:${sky.datasource.port}/${sky.datasource.database}?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
      username: ${sky.datasource.username}
      password: ${sky.datasource.password}
```

application-dev.yml
```yaml
sky:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    host: localhost
    port: 3306
    database: sky_take_out
    username: root
    password: root
```

2ï¼‰é…ç½®ç±»
é…ç½®ç±»æ˜¯é…ç½®æ–‡ä»¶åˆ°Javaå®ä½“ç±»çš„æ˜ å°„

è®¾ç½®æ˜ å°„çš„é…ç½®æ–‡ä»¶ä½ç½®
```java
@ConfigurationProperties(prefix = "sky.alioss")
```

å®Œæ•´ç¤ºä¾‹
```java
@Component
@ConfigurationProperties(prefix = "sky.alioss")
@Data
public class AliOssProperties {

    private String endpoint;
    private String accessKeyId;
    private String accessKeySecret;
    private String bucketName;

}
```

### 3.SpringAOP å®ç°è‡ªåŠ¨åŒ–å­—æ®µå¡«å……
é¦–å…ˆè¦è®¾ç½®ä¸€ä¸ªæ³¨è§£ç±»
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AutoFill {
    OperationType value();
}
```

åˆ›å»ºAOPåˆ‡é¢ï¼Œæ ¹æ®æ³¨è§£è¿‡æ»¤ï¼Œé€šè¿‡å‚æ•°è·å–åå°„æ–¹æ³•ï¼Œæ³¨å…¥å‚æ•°
```java
@Aspect
@Component
@Slf4j
public class AutoFillAspect {
    /**
     * åˆ‡å…¥ç‚¹
     */
    @Pointcut("execution(* com.sky.mapper.*.*(..)) && @annotation(com.sky.annotation.AutoFill)")
    public void autoFillCutPoint(){}

    /**
     * å…¬å…±å­—æ®µèµ‹å€¼
     */
    @Before("autoFillCutPoint()")
    public void autoFill(JoinPoint joinPoint) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        //è·å–æ‹¦æˆªæ–¹æ³•çš„æ•°æ®åº“æ“ä½œç±»å‹
        MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature();
        AutoFill autoFill = methodSignature.getMethod().getAnnotation(AutoFill.class);
        OperationType operationType = autoFill.value();

        //è·å–å‚æ•°
        Object[] args = joinPoint.getArgs();
        if(args == null || args.length == 0) return;

        Object entity = args[0];

        //èµ‹å€¼å‚æ•°
        LocalDateTime now = LocalDateTime.now();
        Long currentId = BaseContext.getCurrentId();

        if(operationType == OperationType.INSERT){
            Method setCreateTime =  entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_TIME, LocalDateTime.class);
            Method setUpdateTime =  entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);
            Method setCreateUser =  entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_USER, Long.class);
            Method setUpdateUser =  entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);
            setCreateTime.invoke(entity, now);
            setUpdateTime.invoke(entity, now);
            setCreateUser.invoke(entity, currentId);
            setUpdateUser.invoke(entity, currentId);
        }else {
            Method setUpdateTime =  entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);
            Method setUpdateUser =  entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);
            setUpdateTime.invoke(entity, now);
            setUpdateUser.invoke(entity, currentId);
        }
    }
}
```

### 4.SpringBoot æ¶ˆæ¯è½¬æ¢å™¨
æ¶ˆæ¯è½¬æ¢å™¨ï¼ˆHttpMessageConverterï¼‰æ˜¯ Spring MVC ä¸­ç”¨äºå¤„ç† HTTP è¯·æ±‚å’Œå“åº”çš„ç»„ä»¶ï¼Œè´Ÿè´£å°† HTTP æ¶ˆæ¯ï¼ˆå¦‚ JSONã€XMLï¼‰ä¸ Java å¯¹è±¡ç›¸äº’è½¬æ¢ã€‚
é‡å†™SpringBootçš„extendMessageConvertersæ–¹æ³•ï¼Œå°†Httpçš„Jsonæ•°æ®å¤„ç†äº¤ç»™è‡ªå®šä¹‰çš„å¯¹è±¡è½¬æ¢å™¨å¤„ç†
```java
@Configuration
@Slf4j
public class WebMvcConfiguration extends WebMvcConfigurationSupport {
    /**
     * æ¶ˆæ¯è½¬æ¢å™¨
     */
    protected void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
        log.info("æ‰©å±•æ¶ˆæ¯è½¬æ¢å™¨...");
        //åˆ›å»ºæ¶ˆæ¯è½¬æ¢å™¨å¯¹è±¡
        MappingJackson2HttpMessageConverter messageConverter = new MappingJackson2HttpMessageConverter();
        //è®¾ç½®å¯¹è±¡è½¬æ¢å™¨ï¼Œåº•å±‚ä½¿ç”¨Jacksonå°†Javaå¯¹è±¡è½¬ä¸ºjson
        messageConverter.setObjectMapper(new JacksonObjectMapper());
        //å°†ä¸Šé¢çš„æ¶ˆæ¯è½¬æ¢å™¨å¯¹è±¡è¿½åŠ åˆ°convertersä¸­
        converters.add(0, messageConverter);
    }
}
```

Jacksonçš„å®ç°ï¼šå°†æ—¶é—´åºåˆ—åŒ–
```java
/**
 * å¯¹è±¡æ˜ å°„å™¨ï¼šåŸºäºjacksonå°†Javaå¯¹è±¡è½¬ä¸ºjsonï¼Œæˆ–è€…å°†jsonè½¬ä¸ºJavaå¯¹è±¡
 * å°†JSONè§£æä¸ºJavaå¯¹è±¡çš„è¿‡ç¨‹ç§°ä¸º [ä»JSONååºåˆ—åŒ–Javaå¯¹è±¡]
 * ä»Javaå¯¹è±¡ç”ŸæˆJSONçš„è¿‡ç¨‹ç§°ä¸º [åºåˆ—åŒ–Javaå¯¹è±¡åˆ°JSON]
 */
public class JacksonObjectMapper extends ObjectMapper {

    public static final String DEFAULT_DATE_FORMAT = "yyyy-MM-dd";
    //public static final String DEFAULT_DATE_TIME_FORMAT = "yyyy-MM-dd HH:mm:ss";
    public static final String DEFAULT_DATE_TIME_FORMAT = "yyyy-MM-dd HH:mm";
    public static final String DEFAULT_TIME_FORMAT = "HH:mm:ss";

    public JacksonObjectMapper() {
        super();
        //æ”¶åˆ°æœªçŸ¥å±æ€§æ—¶ä¸æŠ¥å¼‚å¸¸
        this.configure(FAIL_ON_UNKNOWN_PROPERTIES, false);

        //ååºåˆ—åŒ–æ—¶ï¼Œå±æ€§ä¸å­˜åœ¨çš„å…¼å®¹å¤„ç†
        this.getDeserializationConfig().withoutFeatures(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);

        SimpleModule simpleModule = new SimpleModule()
                .addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))
                .addDeserializer(LocalDate.class, new LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))
                .addDeserializer(LocalTime.class, new LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)))
                .addSerializer(LocalDateTime.class, new LocalDateTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))
                .addSerializer(LocalDate.class, new LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))
                .addSerializer(LocalTime.class, new LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));

        //æ³¨å†ŒåŠŸèƒ½æ¨¡å— ä¾‹å¦‚ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨
        this.registerModule(simpleModule);
    }
}
```

### 5.åŸºäºBeanç®¡ç†çš„å·¥å…·ç±»è®¾è®¡
è¿™æ˜¯ä¸€ä¸ªå¸¦çŠ¶æ€çš„å·¥å…·ç±»ï¼Œé€šè¿‡Propertiesé…ç½®ç±»æ³¨å…¥é…ç½®ä¿¡æ¯ï¼Œå¹¶äº¤ç»™Beanç®¡ç†ï¼ˆ`@ConditionalOnMissingBean`å®é™…çš„æ•ˆæœç±»ä¼¼äºå•ä¾‹æ¨¡å¼ï¼‰
```java
@Configuration
@Slf4j
public class OssConfiguration {
    @Bean
    @ConditionalOnMissingBean
    public AliOssUtil aliOssUtil(AliOssProperties aliOssProperties){
        log.info("å¼€å§‹åˆ›å»ºé˜¿é‡Œäº‘æ–‡ä»¶ä¸Šä¼ å·¥å…·ç±»å¯¹è±¡ï¼š{}", aliOssProperties);
        return new AliOssUtil(aliOssProperties.getEndpoint(),
                aliOssProperties.getAccessKeyId(),
                aliOssProperties.getAccessKeySecret(),
                aliOssProperties.getBucketName());
    }
}
```

## ç»“è¯­
æ˜å¤©çš„ç›®æ ‡æ˜¯å­¦å®ŒDay5å’ŒDay6ï¼Œå†…å®¹ç›¸å¯¹ä¼šæ¯”è¾ƒå¤šï¼ˆä»Šå¤©æ¯”è¾ƒæ°´ï¼‰
æ˜å¤©ä¸€å®šè¦çˆ¬èµ·æ¥å•ŠğŸ˜­